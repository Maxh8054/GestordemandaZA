<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Portal do Gestor - Sistema Corporativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilizar opções de gestores no multi-select */
.multi-select-option label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.multi-select-option .fa-user-shield {
    color: #f39c12;
}

.multi-select-option .fa-user {
    color: #3498db;
}

/* Destaque para gestores selecionados */
.selected-item:has(.fa-user-shield) {
    background-color: rgba(243, 156, 18, 0.2);
    border: 1px solid rgba(243, 156, 18, 0.5);
}

.selected-item:has(.fa-user) {
    background-color: rgba(52, 152, 219, 0.2);
    border: 1px solid rgba(52, 152, 219, 0.5);
}
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #1a252f;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --routine-color: #9b59b6;
            --overdue-color: #e74c3c;
            --gold: #f1c40f;
            --silver: #bdc3c7;
            --bronze: #cd7f32;
            --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Impedir zoom no mobile */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            /* Impedir zoom no mobile */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .login-card p {
            color: var(--gray-color);
            margin-bottom: 30px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus, .login-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .main-container {
            display: none;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 20px;
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .company-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header p {
            margin-top: 5px;
            font-size: 1rem;
            opacity: 0.9;
            text-align: center;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            margin-top: 10px;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-badge.gestor {
            background: rgba(241, 196, 15, 0.3);
            border: 1px solid rgba(241, 196, 15, 0.5);
        }

        .header-controls button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .header-controls button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .notifications-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            color: var(--dark-color);
            margin-top: 5px;
        }

        .notifications-dropdown.show {
            display: block;
        }

        .notifications-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .notification-item:hover {
            background-color: var(--light-color);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item h4 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .notification-item p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--gray-color);
        }

        .notification-item small {
            display: block;
            margin-top: 5px;
            font-size: 0.7rem;
            color: #aaa;
        }

        .notification-actions {
            display: flex;
            gap: 5px;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .priority-notification {
            border-left: 4px solid var(--gold);
            background-color: rgba(241, 196, 15, 0.1);
        }

        .clear-notifications-btn, .priority-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 6px;
            color: #aaa;
        }

        .clear-notifications-btn:hover {
            color: var(--danger-color);
        }
        
        .priority-btn:hover {
            color: var(--gold);
        }

        .filter-container {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-container label {
            font-weight: bold;
            color: var(--dark-color);
            white-space: nowrap;
            font-size: 12px;
        }

        .filter-container select,
        .filter-container input {
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            font-size: 12px;
            padding: 5px;
        }

        .date-filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .stat-card.success::before { background: var(--success-color); }
        .stat-card.warning::before { background: var(--warning-color); }
        .stat-card.danger::before { background: var(--danger-color); }
        .stat-card.info::before { background: var(--info-color); }

        .stat-icon {
            font-size: 2rem;
            margin-right: 15px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            position: relative;
        }

        .stat-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.1); opacity: 0.05; }
            100% { transform: scale(1); opacity: 0.1; }
        }

        .stat-icon.primary { background-color: rgba(44, 62, 80, 0.1); color: var(--primary-color); }
        .stat-icon.success { background-color: rgba(39, 174, 96, 0.1); color: var(--success-color); }
        .stat-icon.warning { background-color: rgba(243, 156, 18, 0.1); color: var(--warning-color); }
        .stat-icon.danger { background-color: rgba(231, 76, 60, 0.1); color: var(--danger-color); }
        .stat-icon.info { background-color: rgba(52, 152, 219, 0.1); color: var(--info-color); }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend-indicator {
            display: none !important;
        }

        .stat-info p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card h2 {
            margin: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-actions button {
            padding: 5px 10px;
            font-size: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .card-actions button:hover {
            background: var(--primary-color);
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .dias-semana-group {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
        }

        .dias-semana-group label {
            display: inline-block;
            margin-right: 10px;
            font-weight: normal;
        }

        .dias-semana-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:active::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #229954;
        }

        button.secondary {
            background-color: var(--gray-color);
        }

        button.secondary:hover {
            background-color: #5a6268;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .demanda-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: var(--light-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .demanda-item:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .demanda-item.pendente { border-left: 5px solid var(--warning-color); }
        .demanda-item.aprovada { border-left: 5px solid var(--success-color); }
        .demanda-item.reprovada { border-left: 5px solid var(--danger-color); }
        .demanda-item.finalizado_pendente_aprovacao { border-left: 5px solid var(--primary-color); }
        .demanda-item.atribuida_pendente_aceitacao { 
            border-left: 5px solid var(--info-color); 
            background-color: rgba(52, 152, 219, 0.1);
        }
        .demanda-item.reprovada_pelo_atribuido { 
            border-left: 5px solid var(--warning-color); 
            background-color: rgba(243, 156, 18, 0.1);
        }
        .demanda-item.atrasado { 
            border-left: 5px solid var(--overdue-color); 
            background-color: rgba(231, 76, 60, 0.1);
        }
        .demanda-item.rotina { 
            border-left: 5px solid var(--routine-color); 
            background-color: rgba(155, 89, 182, 0.1);
        }
        .demanda-item.rotina .demanda-info strong {
            color: var(--routine-color);
        }
        .demanda-item.atrasado .demanda-info .time-remaining {
            color: var(--overdue-color);
            font-weight: bold;
        }

        .demanda-priority {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high {
            background: var(--danger-color);
            color: white;
        }

        .priority-medium {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .priority-low {
            background: var(--success-color);
            color: white;
        }

        .demanda-info {
            flex-grow: 1;
        }

        .demanda-info strong {
            display: block;
            font-size: 1.1em;
        }

        .demanda-info small {
            color: var(--gray-color);
            display: block;
            margin-top: 5px;
        }

        .time-remaining {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            display: inline-block;
        }

        .time-completed {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 4px;
            display: inline-block;
            color: var(--success-color);
        }
        
        .time-performance {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .time-performance.early {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .time-performance.late {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .acoes-demandas {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .acoes-demandas button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }

        .import-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .import-area.highlight {
            border-color: var(--primary-color);
            background-color: #e9f5ff;
        }

        .import-area i {
            font-size: 3em;
            color: var(--gray-color);
            margin-bottom: 15px;
        }

        .import-area p {
            margin: 0;
            color: var(--gray-color);
        }

        .import-area #importStatus {
            margin-top: 15px;
            font-weight: bold;
        }

        .ranking-container {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .ranking-container h2 {
            margin-top: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: var(--light-color);
            transform: translateX(5px);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-position {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .ranking-info {
            flex-grow: 1;
        }

        .ranking-info strong {
            display: block;
            font-size: 1.1rem;
        }

        .ranking-info small {
            color: var(--gray-color);
        }

        .ranking-stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .ranking-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .stat-badge.concluidas {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--success-color);
        }

        .stat-badge.andamento {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }

        .stat-badge.atrasadas {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            position: relative;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            font-weight: 500;
        }

        .tab:hover {
            background-color: rgba(44, 62, 80, 0.05);
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.6rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .chart-container h3 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-actions {
            display: flex;
            gap: 5px;
        }

        .chart-actions button {
            padding: 5px 10px;
            font-size: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .chart-actions button:hover {
            background: var(--primary-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 350px;
            display: none;
            border-left: 5px solid var(--primary-color);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
        }

        .notification p {
            margin: 0;
            color: var(--gray-color);
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .search-bar i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .dashboard { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .filter-container { flex-direction: column; align-items: stretch; }
            .filter-container select { max-width: 100%; }
            
            .header-logo {
                flex-direction: column;
                text-align: center;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            header p {
                font-size: 0.9rem;
            }
            
            .header-controls {
                flex-direction: column;
                width: 100%;
                gap: 5px;
            }
            
            .user-badge {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content { width: 95%; margin: 5% auto; }
            
            .card-actions {
                justify-content: center;
                width: 100%;
            }
            
            .card-actions button {
                font-size: 10px;
                padding: 4px 8px;
            }
            
            .acoes-demandas {
                flex-direction: column;
                width: 100%;
            }
            
            .acoes-demandas button {
                margin-right: 0;
                margin-bottom: 5px;
                width: 100%;
            }
            
            .ranking-stats {
                flex-direction: column;
                gap: 5px;
            }
            
            .deadline-extension {
                margin-top: 10px;
            }
            
            .cobranca-container .card-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .cobranca-container .card-actions button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .password-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .password-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .password-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .server-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10000;
        }

        .server-status.connected {
            background: rgba(39, 174, 96, 0.8);
        }

        .server-status.disconnected {
            background: rgba(231, 76, 60, 0.8);
        }

        .email-template {
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .email-template h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .email-template .email-subject {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .email-template .email-body {
            white-space: pre-line;
            line-height: 1.5;
            color: var(--dark-color);
        }

        .email-template .email-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .file-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item button {
            padding: 2px 6px;
            font-size: 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 42px;
            align-items: center;
        }

        .multi-select-display:hover {
            border-color: var(--primary-color);
        }

        .selected-item {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-item i {
            cursor: pointer;
            font-size: 10px;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background-color: #f0f0f0;
        }

        .multi-select-option.selected {
            background-color: rgba(44, 62, 80, 0.1);
        }

        .multi-select-option input {
            width: auto;
            margin: 0;
        }

        .reminder-item {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .reminder-item strong {
            color: var(--warning-color);
        }

        .mindmap-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            min-height: 600px;
            position: relative;
            padding-top: 60px; /* Espaço reduzido para filtros menores */
        }

        .mindmap-container .card-header {
            position: absolute;
            top: 10px; /* Posicionado mais no topo */
            left: 10px;
            right: 10px;
            z-index: 100;
            padding: 5px 0;
        }

        .mindmap-container .card-header h2 {
            font-size: 1.2rem; /* Reduzido */
            margin: 0;
        }

        .mindmap-container .card-actions {
            gap: 5px; /* Reduzido */
        }

        .mindmap-container .card-actions select,
        .mindmap-container .card-actions button {
            font-size: 12px; /* Reduzido */
            padding: 4px 8px; /* Reduzido */
        }

        .mindmap-node {
            position: absolute;
            background: var(--primary-color);
            color: white;
            padding: 8px 12px; /* Reduzido */
            border-radius: 20px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            transition: transform 0.2s;
            font-size: 11px; /* Reduzido */
            max-width: 100px; /* Reduzido */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mindmap-node:hover {
            transform: scale(1.05);
            z-index: 20;
        }

        .mindmap-node.high-priority {
            background: var(--danger-color);
        }

        .mindmap-node.medium-priority {
            background: var(--warning-color);
        }

        .mindmap-node.low-priority {
            background: var(--success-color);
        }

        .mindmap-node.pending {
            background: var(--warning-color);
        }

        .mindmap-node.in-analysis {
            background: var(--info-color);
        }

        .mindmap-node.completed {
            background: var(--success-color);
        }

        .mindmap-node.overdue {
            background: var(--overdue-color);
        }

        .notes-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .note-item {
            background: #f9f9f9;
            border-left: 4px solid var(--info-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--gray-color);
        }

        .note-actions {
            display: flex;
            gap: 5px;
        }

        .note-actions button {
            padding: 2px 6px;
            font-size: 12px;
            background: transparent;
            color: var(--gray-color);
            border: none;
            cursor: pointer;
        }

        .note-actions button:hover {
            color: var(--danger-color);
        }

        .category-search {
            position: relative;
        }

        .category-search input {
            padding-right: 40px;
        }

        .category-search button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
        }

        .category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .category-option {
            padding: 8px 12px;
            cursor: pointer;
        }

        .category-option:hover {
            background-color: #f0f0f0;
        }

        .custom-category-input {
            display: none;
            margin-top: 10px;
        }

        .deadline-extension {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
        }

        .deadline-extension.active {
            display: block;
        }

        .auth-links {
            margin-top: 20px;
            text-align: center;
        }

        .auth-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
            font-size: 14px;
            transition: color 0.3s;
        }

        .auth-links a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .form-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.5s ease;
            margin: 0 auto;
        }

        .form-container h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .form-container p {
            color: var(--gray-color);
            margin-bottom: 30px;
        }

        .back-to-login {
            margin-top: 20px;
            text-align: center;
        }

        .back-to-login a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .back-to-login a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .reassign-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .reassign-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .month-filter {
            margin-bottom: 15px;
        }

        .year-filter {
            margin-bottom: 15px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 200px;
        }

        .tooltip.show {
            opacity: 1;
        }

        .demanda-checkbox {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        .batch-actions {
            background: var(--light-color);
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .transcription-area {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            background-color: #f9f9f9;
        }

        .transcription-area p {
            margin: 0;
            color: #666;
            font-style: italic;
        }

        .transcription-area.active {
            background-color: #e9f5ff;
            border-color: var(--info-color);
        }

        .transcription-area.active p {
            color: var(--info-color);
        }

        /* Melhorias de layout */
        .demanda-container {
            margin-top: 30px;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .stats-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-summary-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            min-width: 150px;
            margin-bottom: 10px;
        }

        .stat-summary-item h4 {
            margin: 0 0 5px 0;
            color: var(--dark-color);
        }

        .stat-summary-item p {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        /* Permitir seleção de texto nos modais */
.modal-content {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}

/* Garantir que todos os elementos dentro do modal sejam selecionáveis */
.modal-content p,
.modal-content h1,
.modal-content h2,
.modal-content h3,
.modal-content h4,
.modal-content h5,
.modal-content h6,
.modal-content strong,
.modal-content span,
.modal-content small,
.modal-content div {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}

/* Manter a não seleção apenas em elementos específicos que não devem ser selecionados */
.modal-content button,
.modal-content input,
.modal-content select,
.modal-content textarea {
    -webkit-user-select: auto;
    -moz-user-select: auto;
    -ms-user-select: auto;
    user-select: auto;
}
    </style>
</head>
<body>

<div class="server-status" id="serverStatus">
    <i class="fas fa-circle"></i> <span id="serverStatusText">Verificando servidor...</span>
</div>

<!-- Container de Login -->
<div class="login-container" id="loginContainer">
    <div class="login-card">
        <!-- COLE AQUI O BASE64 DO LOGO DA EMPRESA -->
        <div class="company-logo" style="margin: 0 auto 20px;">
            <!-- Cole aqui a tag <img> com o base64 do logo -->
            <!-- Exemplo: <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="Logo"> -->
        </div>
        
        <h1><i class="fas fa-chart-line"></i> Portal do Gestor</h1>
        <p>Sistema Corporativo de Gestão de Demandas</p>
        
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="userSelect">Selecione seu nome:</label>
                <select id="userSelect" required>
                    <option value="">Clique para selecionar...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="passwordInput">Senha:</label>
                <input type="password" id="passwordInput" placeholder="Digite sua senha" required>
            </div>
            
            <div class="user-info">
                <small><i class="fas fa-info-circle"></i> Funcionários: use sua senha padrão</small><br>
                <small><i class="fas fa-shield-alt"></i> Gestor: senha de administrador</small>
            </div>
            
            <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
        </form>
        
        <div class="auth-links">
            <a href="#" onclick="showForgotPassword()">Esqueceu a senha?</a>
            <a href="#" onclick="showRegister()">Novo usuário</a>
        </div>
    </div>
</div>

<!-- Container de Esqueci Senha -->
<div class="login-container" id="forgotPasswordContainer" style="display: none;">
    <div class="form-container">
        <h1><i class="fas fa-key"></i> Redefinir Senha</h1>
        <p>Informe seu email e defina uma nova senha</p>
        
        <form id="forgotPasswordForm">
            <div class="form-group">
                <label for="forgotEmail">Email:</label>
                <input type="email" id="forgotEmail" placeholder="Digite seu email" required>
            </div>
            
            <div class="form-group">
                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" placeholder="Digite sua nova senha" required>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirmar Senha:</label>
                <input type="password" id="confirmPassword" placeholder="Confirme sua nova senha" required>
            </div>
            
            <button type="submit" class="login-btn">
                <i class="fas fa-paper-plane"></i> Enviar Email de Recuperação
            </button>
        </form>
        
        <div class="back-to-login">
            <a href="#" onclick="showLogin()">Voltar para o login</a>
        </div>
    </div>
</div>

<!-- Container de Cadastro -->
<div class="login-container" id="registerContainer" style="display: none;">
    <div class="form-container">
        <h1><i class="fas fa-user-plus"></i> Cadastro de Usuário</h1>
        <p>Preencha seus dados para solicitar acesso</p>
        
        <form id="registerForm">
            <div class="form-group">
                <label for="registerName">Nome Completo:</label>
                <input type="text" id="registerName" placeholder="Digite seu nome completo" required>
            </div>
            
            <div class="form-group">
                <label for="registerEmail">Email:</label>
                <input type="email" id="registerEmail" placeholder="Digite seu email" required>
            </div>
            
            <div class="form-group">
                <label for="registerPassword">Senha:</label>
                <input type="password" id="registerPassword" placeholder="Digite sua senha" required>
            </div>
            
            <div class="form-group">
                <label for="registerRole">Tipo de Usuário:</label>
                <select id="registerRole" required>
                    <option value="">Selecione...</option>
                    <option value="funcionario">Funcionário</option>
                    <option value="gestor">Gestor</option>
                </select>
            </div>
            
            <button type="submit" class="login-btn">
                <i class="fas fa-user-plus"></i> Solicitar Cadastro
            </button>
        </form>
        
        <div class="back-to-login">
            <a href="#" onclick="showLogin()">Voltar para o login</a>
        </div>
    </div>
</div>

<div class="main-container" id="mainContainer">
    <div class="container">
        <header>
            <div class="header-logo">
                <!-- COLE AQUI O BASE64 DO LOGO DA EMPRESA -->
                <div class="company-logo">
                    <!-- Cole aqui a tag <img> com o base64 do logo -->
                    <!-- Exemplo: <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="Logo"> -->
                </div>
                <div>
                    <h1><i class="fas fa-chart-line"></i> Portal do Gestor Corporativo</h1>
                    <p>Sistema Avançado de Gestão de Demandas</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="user-badge" id="userBadge">
                    <i class="fas fa-user"></i>
                    <span id="userName">Carregando...</span>
                </div>
                <div style="position: relative;">
                    <button onclick="toggleNotificationsDropdown()" title="Notificações">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationCount">0</span>
                    </button>
                    <div id="notificationsDropdown" class="notifications-dropdown">
                        <div class="notifications-header">
                            <span>Notificações</span>
                            <button class="clear-notifications-btn" onclick="clearAllNotifications()">Limpar</button>
                        </div>
                        <div id="notificationsList">
                            <p style="padding: 15px; text-align: center; color: #aaa;">Nenhuma notificação</p>
                        </div>
                    </div>
                </div>
                <button onclick="logout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main>
            <div class="dashboard">
                <div class="stat-card" onclick="drillDown('total')">
                    <div class="stat-icon primary">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalDemandas">0</h3>
                        <p>Total de Demandas</p>
                    </div>
                </div>
                <div class="stat-card warning" onclick="drillDown('pending')">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pendentesCount">0</h3>
                        <p>Em Andamento</p>
                    </div>
                </div>
                <div class="stat-card danger" onclick="drillDown('overdue')">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="atrasadasCount">0</h3>
                        <p>Atrasadas</p>
                    </div>
                </div>
                <div class="stat-card success" onclick="drillDown('completed')">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="aprovadasCount">0</h3>
                        <p>Concluídas</p>
                    </div>
                </div>
                <div class="stat-card info" onclick="drillDown('routine')">
                    <div class="stat-icon info">
                        <i class="fas fa-redo"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="rotinaCount">0</h3>
                        <p>Tarefas de Rotina</p>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </div>
                <div class="tab" onclick="switchTab('nova')">
                    <i class="fas fa-plus-circle"></i> Nova Demanda
                </div>
                <div class="tab" id="gestorTab" style="display: none;" onclick="switchTab('pendentes-colaboradores')">
                    <i class="fas fa-users"></i> Pendentes Colaboradores
                    <span class="badge" id="colabPendingBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('pendentes')">
                    <i class="fas fa-clock"></i> Minhas Demandas
                    <span class="badge" id="pendingBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('analise')">
                    <i class="fas fa-search"></i> Análise
                    <span class="badge" id="analysisBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('atrasadas')">
                    <i class="fas fa-exclamation-triangle"></i> Atrasadas
                    <span class="badge" id="overdueBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('aprovadas')">
                    <i class="fas fa-check-circle"></i> Concluídas
                    <span class="badge" id="completedBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('mindmap')">
                    <i class="fas fa-project-diagram"></i> Mapa Mental
                </div>
                <div class="tab" onclick="switchTab('notes')">
                    <i class="fas fa-sticky-note"></i> Anotações
                </div>
                <div class="tab" id="gestorTab2" style="display: none;" onclick="switchTab('ranking')">
                    <i class="fas fa-chart-bar"></i> Ranking
                </div>
                <div class="tab" id="gestorTab4" style="display: none;" onclick="switchTab('cobranca')">
                    <i class="fas fa-envelope"></i> Cobrança
                </div>
                <div class="tab" id="gestorTab5" style="display: none;" onclick="switchTab('exportar')">
                    <i class="fas fa-download"></i> Exportar/Importar
                </div>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="filter-container">
                    <label for="filtroFuncionario">Filtrar por Funcionário:</label>
                    <select id="filtroFuncionario" onchange="filtrarDashboard()">
                        <option value="todos">Todos os Funcionários</option>
                    </select>
                    
                    <label for="filtroPeriodo">Período:</label>
                    <select id="filtroPeriodo" onchange="filtrarDashboard()">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="365">Último ano</option>
                    </select>
                    
                    <label for="filtroCategoria">Categoria:</label>
                    <select id="filtroCategoria" onchange="filtrarDashboard()">
                        <option value="todas">Todas</option>
                        <option value="Comercial / Negócio">Comercial / Negócio</option>
                        <option value="Vendas">Vendas</option>
                        <option value="Pós-venda">Pós-venda</option>
                        <option value="Negociação">Negociação</option>
                        <option value="Proposta / Orçamento">Proposta / Orçamento</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Fidelização">Fidelização</option>
                        <option value="Gestão / Administrativo">Gestão / Administrativo</option>
                        <option value="Planejamento">Planejamento</option>
                        <option value="Gestão de Projetos">Gestão de Projetos</option>
                        <option value="Alinhamento Interno">Alinhamento Interno</option>
                        <option value="Tomada de Decisão">Tomada de Decisão</option>
                        <option value="Auditoria">Auditoria</option>
                        <option value="Compras">Compras</option>
                        <option value="Técnico / Operacional">Técnico / Operacional</option>
                        <option value="Manutenção">Manutenção</option>
                        <option value="Implantação">Implantação</option>
                        <option value="Testes">Testes</option>
                        <option value="Correção de Erros">Correção de Erros</option>
                        <option value="Monitoramento">Monitoramento</option>
                        <option value="Otimização">Otimização</option>
                        <option value="TI / Dados">TI / Dados</option>
                        <option value="Análise de Dados">Análise de Dados</option>
                        <option value="Automação">Automação</option>
                        <option value="Integração de Sistemas">Integração de Sistemas</option>
                        <option value="Infraestrutura">Infraestrutura</option>
                        <option value="Segurança">Segurança</option>
                        <option value="Backup">Backup</option>
                        <option value="Comunicação">Comunicação</option>
                        <option value="Apresentação">Apresentação</option>
                        <option value="Treinamento">Treinamento</option>
                        <option value="Documentação">Documentação</option>
                        <option value="Feedback">Feedback</option>
                        <option value="Atendimento">Atendimento</option>
                        <option value="Outros">Outros</option>
                    </select>
                    
                    <label for="filtroPrioridade">Prioridade:</label>
                    <select id="filtroPrioridade" onchange="filtrarDashboard()">
                        <option value="todas">Todas</option>
                        <option value="Importante">Importante</option>
                        <option value="Média">Média</option>
                        <option value="Relevante">Relevante</option>
                    </select>
                    
                    <button onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Resetar
                    </button>
                </div>

                <div class="reminder-container" id="reminderContainer" style="display: none;">
                    <h3><i class="fas fa-bell"></i> Lembretes de Prazo</h3>
                    <div id="reminderList"></div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>
                            <span><i class="fas fa-chart-pie"></i> Distribuição de Status</span>
                            <div class="chart-actions">
                                <button onclick="refreshChart('status')"><i class="fas fa-sync-alt"></i></button>
                                <button onclick="downloadChart('status')"><i class="fas fa-download"></i></button>
                            </div>
                        </h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="nova" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> Registrar Nova Demanda</h2>
                    <form id="demandaForm">
                        <div class="form-group">
                            <label for="nomeDemandaInput">Nome da Demanda:</label>
                            <input type="text" id="nomeDemandaInput" required placeholder="Dê um nome claro para a demanda">
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="categoriaInput">Categoria:</label>
                                <div class="category-search">
                                    <input type="text" id="categoriaInput" placeholder="Digite ou selecione uma categoria" required oninput="filtrarCategorias()">
                                    <button type="button" onclick="toggleCategoryDropdown()"><i class="fas fa-chevron-down"></i></button>
                                    <div id="categoryDropdown" class="category-dropdown">
                                        <div class="category-option" onclick="selectCategory('Comercial / Negócio')">Comercial / Negócio</div>
                                        <div class="category-option" onclick="selectCategory('Vendas')">Vendas</div>
                                        <div class="category-option" onclick="selectCategory('Pós-venda')">Pós-venda</div>
                                        <div class="category-option" onclick="selectCategory('Negociação')">Negociação</div>
                                        <div class="category-option" onclick="selectCategory('Proposta / Orçamento')">Proposta / Orçamento</div>
                                        <div class="category-option" onclick="selectCategory('Follow-up')">Follow-up</div>
                                        <div class="category-option" onclick="selectCategory('Fidelização')">Fidelização</div>
                                        <div class="category-option" onclick="selectCategory('Gestão / Administrativo')">Gestão / Administrativo</div>
                                        <div class="category-option" onclick="selectCategory('Planejamento')">Planejamento</div>
                                        <div class="category-option" onclick="selectCategory('Gestão de Projetos')">Gestão de Projetos</div>
                                        <div class="category-option" onclick="selectCategory('Alinhamento Interno')">Alinhamento Interno</div>
                                        <div class="category-option" onclick="selectCategory('Tomada de Decisão')">Tomada de Decisão</div>
                                        <div class="category-option" onclick="selectCategory('Auditoria')">Auditoria</div>
                                        <div class="category-option" onclick="selectCategory('Compliance')">Compliance</div>
                                        <div class="category-option" onclick="selectCategory('Técnico / Operacional')">Técnico / Operacional</div>
                                        <div class="category-option" onclick="selectCategory('Manutenção')">Manutenção</div>
                                        <div class="category-option" onclick="selectCategory('Implantação')">Implantação</div>
                                        <div class="category-option" onclick="selectCategory('Testes')">Testes</div>
                                        <div class="category-option" onclick="selectCategory('Correção de Erros')">Correção de Erros</div>
                                        <div class="category-option" onclick="selectCategory('Monitoramento')">Monitoramento</div>
                                        <div class="category-option" onclick="selectCategory('Otimização')">Otimização</div>
                                        <div class="category-option" onclick="selectCategory('TI / Dados')">TI / Dados</div>
                                        <div class="category-option" onclick="selectCategory('Análise de Dados')">Análise de Dados</div>
                                        <div class="category-option" onclick="selectCategory('Automação')">Automação</div>
                                        <div class="category-option" onclick="selectCategory('Integração de Sistemas')">Integração de Sistemas</div>
                                        <div class="category-option" onclick="selectCategory('Infraestrutura')">Infraestrutura</div>
                                        <div class="category-option" onclick="selectCategory('Segurança')">Segurança</div>
                                        <div class="category-option" onclick="selectCategory('Backup')">Backup</div>
                                        <div class="category-option" onclick="selectCategory('Comunicação')">Comunicação</div>
                                        <div class="category-option" onclick="selectCategory('Apresentação')">Apresentação</div>
                                        <div class="category-option" onclick="selectCategory('Treinamento')">Treinamento</div>
                                        <div class="category-option" onclick="selectCategory('Documentação')">Documentação</div>
                                        <div class="category-option" onclick="selectCategory('Feedback')">Feedback</div>
                                        <div class="category-option" onclick="selectCategory('Atendimento')">Atendimento</div>
                                        <div class="category-option" onclick="selectCategory('Outros')">Outros</div>
                                    </div>
                                </div>
                                <div id="customCategoryInput" class="custom-category-input">
                                    <input type="text" id="customCategory" placeholder="Digite uma nova categoria">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="prioridadeSelect">Prioridade:</label>
                                <select id="prioridadeSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Importante">Importante</option>
                                    <option value="Média">Média</option>
                                    <option value="Relevante">Relevante</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="complexidadeSelect">Complexidade:</label>
                                <select id="complexidadeSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Fácil">Fácil</option>
                                    <option value="Médio">Médio</option>
                                    <option value="Difícil">Difícil</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="localSelect">Local:</label>
                                <select id="localSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Lundin">Lundin</option>
                                    <option value="R&D">R&D</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="atribuidoASelect">Atribuir a:</label>
                            <div class="multi-select-container" id="atribuidoAContainer">
                                <div class="multi-select-display" id="atribuidoADisplay" onclick="toggleMultiSelect('atribuidoA')">
                                    <span style="color: #999;">Clique para selecionar funcionários...</span>
                                </div>
                                <div class="multi-select-dropdown" id="atribuidoADropdown">
                                    <!-- Opções serão preenchidas dinamicamente -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="demandaInput">Descrição da Demanda:</label>
                            <textarea id="demandaInput" rows="3" required placeholder="Descreva detalhadamente a demanda..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dataLimiteInput">Data Limite:</label>
                            <input type="date" id="dataLimiteInput" required onchange="validateDeadline()">
                        </div>
                        
                        <div class="form-group">
                            <label for="anexosCriacaoInput">Anexar Documentos/Imagens (Opcional):</label>
                            <input type="file" id="anexosCriacaoInput" multiple>
                            <div id="anexosCriacaoList" class="file-list"></div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="rotinaCheckbox" onchange="toggleRoutineFields()">
                            <label for="rotinaCheckbox">Esta é uma tarefa de rotina</label>
                        </div>
                        
                        <div class="dias-semana-group" id="diasSemanaGroup">
                            <label>Selecione os dias da semana:</label>
                            <div>
                                <label><input type="checkbox" name="diaSemana" value="0"> Domingo</label>
                                <label><input type="checkbox" name="diaSemana" value="1"> Segunda-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="2"> Terça-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="3"> Quarta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="4"> Quinta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="5"> Sexta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="6"> Sábado</label>
                            </div>
                        </div>
                        
                        <button type="submit">
                            <i class="fas fa-save"></i> Registrar Demanda
                        </button>
                    </form>
                </div>
            </div>

            <div id="pendentes" class="tab-content">
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-clock"></i> Minhas Demandas Pendentes</h2>
                    <div class="card-header">
                        <div class="card-actions">
                            <select id="pendentesFilter" onchange="filterPendentes()">
                                <option value="todos">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="reprovada">Reprovada</option>
                                <option value="atribuida_pendente_aceitacao">Atribuída</option>
                            </select>
                            <div class="date-filter-container">
                                <div class="year-filter">
                                    <label for="pendentesYearFilter">Ano:</label>
                                    <select id="pendentesYearFilter" onchange="filterPendentes()">
                                        <option value="">Todos os anos</option>
                                    </select>
                                </div>
                                <div class="month-filter">
                                    <label for="pendentesMonthFilter">Mês:</label>
                                    <select id="pendentesMonthFilter" onchange="filterPendentes()">
                                        <option value="">Todos os meses</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="demanda-container" id="pendentesContainer"></div>
                </div>
            </div>

          <div id="analise" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-search"></i> Demandas em Análise</h2>
            <div class="card-actions">
                <!-- NOVO FILTRO POR COLABORADORES -->
                <select id="analiseFuncFilter" onchange="filterAnalise()">
                    <option value="todos">Todos os Colaboradores</option>
                </select>
                
                <!-- FILTROS DE DATA (MANTIDOS) -->
                <div class="date-filter-container">
                    <div class="year-filter">
                        <label for="analiseYearFilter">Ano:</label>
                        <select id="analiseYearFilter" onchange="filterAnalise()">
                            <option value="">Todos os anos</option>
                        </select>
                    </div>
                    <div class="month-filter">
                        <label for="analiseMonthFilter">Mês:</label>
                        <select id="analiseMonthFilter" onchange="filterAnalise()">
                            <option value="">Todos os meses</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div id="analiseContainer"></div>
    </div>
</div>

         <div id="atrasadas" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-exclamation-triangle"></i> Demandas Atrasadas</h2>
            <div class="card-actions" id="gestorActions2" style="display: none;">
                <button onclick="reassignSelectedOverdue()"><i class="fas fa-user-plus"></i> Reatribuir</button>
                <button onclick="extendSelectedDeadlines()"><i class="fas fa-calendar-plus"></i> Estender Prazos</button>
            </div>
            <!-- NOVO FILTRO POR COLABORADORES -->
            <select id="atrasadasFuncFilter" onchange="filterAtrasadas()">
                <option value="todos">Todos os Colaboradores</option>
            </select>
            <div class="date-filter-container">
                <div class="year-filter">
                    <label for="atrasadasYearFilter">Ano:</label>
                    <select id="atrasadasYearFilter" onchange="filterAtrasadas()">
                        <option value="">Todos os anos</option>
                    </select>
                </div>
                <div class="month-filter">
                    <label for="atrasadasMonthFilter">Mês:</label>
                    <select id="atrasadasMonthFilter" onchange="filterAtrasadas()">
                        <option value="">Todos os meses</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="batch-actions" id="overdueBatchActions" style="display: none;">
            <button onclick="selectAllOverdue()"><i class="fas fa-check-square"></i> Selecionar Todas</button>
            <button onclick="deselectAllOverdue()"><i class="fas fa-square"></i> Desmarcar Todas</button>
            <span id="selectedOverdueCount">0 demandas selecionadas</span>
        </div>
        <div id="atrasadasContainer"></div>
    </div>
</div>

            <div id="aprovadas" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-check-circle"></i> Minhas Demandas Concluídas</h2>
            <div class="card-actions" id="gestorActions3" style="display: none;">
                <button onclick="exportCompleted()"><i class="fas fa-download"></i> Exportar Concluídas</button>
            </div>
            <!-- NOVO FILTRO POR COLABORADORES -->
            <select id="aprovadasFuncFilter" onchange="filterAprovadas()">
                <option value="todos">Todos os Colaboradores</option>
            </select>
            <div class="date-filter-container">
                <div class="year-filter">
                    <label for="aprovadasYearFilter">Ano:</label>
                    <select id="aprovadasYearFilter" onchange="filterAprovadas()">
                        <option value="">Todos os anos</option>
                    </select>
                </div>
                <div class="month-filter">
                    <label for="aprovadasMonthFilter">Mês:</label>
                    <select id="aprovadasMonthFilter" onchange="filterAprovadas()">
                        <option value="">Todos os meses</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="aprovadasContainer"></div>
    </div>
</div>

            <div id="mindmap" class="tab-content">
                <div class="mindmap-container">
                    <div class="card-header">
                        <h2><i class="fas fa-project-diagram"></i> Mapa Mental de Prioridades</h2>
                        <div class="card-actions">
                            <select id="mindmapFilter" onchange="filterMindmap()">
                                <option value="todos">Todas as demandas</option>
                                <option value="pendente">Pendentes</option>
                                <option value="finalizado_pendente_aprovacao">Em Análise</option>
                                <option value="aprovada">Concluídas</option>
                                <option value="atrasado">Atrasadas</option>
                            </select>
                            <select id="mindmapFuncFilter" onchange="filterMindmap()">
                                <option value="todos">Todos os Funcionários</option>
                            </select>
                            <select id="mindmapLocalFilter" onchange="filterMindmap()">
                                <option value="todos">Todos os Locais</option>
                                <option value="Lundin">Lundin</option>
                                <option value="R&D">R&D</option>
                            </select>
                            <select id="mindmapSort" onchange="sortMindmap()">
                                <option value="prioridade">Ordenar por Prioridade</option>
                                <option value="dataLimite">Ordenar por Data Limite</option>
                                <option value="categoria">Ordenar por Categoria</option>
                            </select>
                            <button onclick="resetMindmap()"><i class="fas fa-undo"></i> Resetar</button>
                            <button onclick="saveMindmapLayout()"><i class="fas fa-save"></i> Salvar Layout</button>
                        </div>
                    </div>
                    <div id="mindmapArea">
                        <!-- Nós do mapa mental serão adicionados dinamicamente -->
                    </div>
                </div>
            </div>

            <div id="notes" class="tab-content">
                <div class="notes-container">
                    <div class="card-header">
                        <h2><i class="fas fa-sticky-note"></i> Minhas Anotações</h2>
                        <button onclick="addNewNote()"><i class="fas fa-plus"></i> Nova Anotação</button>
                    </div>
                    <div class="date-filter-container">
                        <div class="year-filter">
                            <label for="notesYearFilter">Ano:</label>
                            <select id="notesYearFilter" onchange="filterNotes()">
                                <option value="">Todos os anos</option>
                            </select>
                        </div>
                        <div class="month-filter">
                            <label for="notesMonthFilter">Mês:</label>
                            <select id="notesMonthFilter" onchange="filterNotes()">
                                <option value="">Todos os meses</option>
                            </select>
                        </div>
                    </div>
                    <div id="notesContainer">
                        <!-- Anotações serão adicionadas dinamicamente -->
                    </div>
                </div>
            </div>

            <div id="ranking" class="tab-content">
                <div class="ranking-container">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-bar"></i> Estatísticas por Funcionário</h2>
                        <div class="card-actions">
                            <button onclick="changeRankingPeriod()"><i class="fas fa-calendar"></i> Período</button>
                            <button onclick="exportRanking()" id="exportRankingBtn" style="display: none;"><i class="fas fa-download"></i> Exportar</button>
                        </div>
                    </div>
                    <div class="date-filter-container">
                        <div class="year-filter">
                            <label for="rankingYearFilter">Ano:</label>
                            <select id="rankingYearFilter" onchange="updateRanking()">
                                <option value="">Todos os anos</option>
                            </select>
                        </div>
                        <div class="month-filter">
                            <label for="rankingMonthFilter">Mês:</label>
                            <select id="rankingMonthFilter" onchange="updateRanking()">
                                <option value="">Todos os meses</option>
                            </select>
                        </div>
                    </div>
                    <ul class="ranking-list" id="rankingList"></ul>
                </div>
            </div>

            <div id="pendentes-colaboradores" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> Demandas dos Colaboradores</h2>
                        <div class="card-actions">
                            <select id="colabFilter" onchange="filterColabDemandas()">
                                <option value="todos">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="finalizado_pendente_aprovacao">Pendente Aprovação</option>
                                <option value="reprovada">Reprovada</option>
                                <option value="atribuida_pendente_aceitacao">Atribuída</option>
                            </select>
                            <select id="colabFuncFilter" onchange="filterColabDemandas()">
                                <option value="todos">Todos os Funcionários</option>
                            </select>
                            <select id="colabLocalFilter" onchange="filterColabDemandas()">
                                <option value="todos">Todos os Locais</option>
                                <option value="Lundin">Lundin</option>
                                <option value="R&D">R&D</option>
                            </select>
                            <div class="date-filter-container">
                                <div class="year-filter">
                                    <label for="colabYearFilter">Ano:</label>
                                    <select id="colabYearFilter" onchange="filterColabDemandas()">
                                        <option value="">Todos os anos</option>
                                    </select>
                                </div>
                                <div class="month-filter">
                                    <label for="colabMonthFilter">Mês:</label>
                                    <select id="colabMonthFilter" onchange="filterColabDemandas()">
                                        <option value="">Todos os meses</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="colabContainer"></div>
                </div>
            </div>

            <div id="cobranca" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-envelope"></i> Sistema de Cobrança</h2>
                    <p>Envie emails de cobrança para as demandas que estão em atraso.</p>
                    
                    <div class="filter-container">
                        <label for="cobrancaFuncionario">Filtrar por Funcionário:</label>
                        <select id="cobrancaFuncionario">
                            <option value="todos">Todos os Funcionários com Demandas Atrasadas</option>
                        </select>
                        
                        <label for="cobrancaPrioridade">Filtrar por Prioridade:</label>
                        <select id="cobrancaPrioridade">
                            <option value="todas">Todas as Prioridades</option>
                            <option value="Importante">Importante</option>
                            <option value="Média">Média</option>
                            <option value="Relevante">Relevante</option>
                        </select>
                        
                        <button onclick="filtrarCobranca()"><i class="fas fa-filter"></i> Filtrar</button>
                        <button onclick="resetFiltrosCobranca()"><i class="fas fa-undo"></i> Resetar</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-list"></i> Demandas em Atraso</h3>
                            <div class="card-actions">
                                <button onclick="selectAllOverdue()"><i class="fas fa-check-square"></i> Selecionar Todas</button>
                                <button onclick="deselectAllOverdue()"><i class="fas fa-square"></i> Desmarcar Todas</button>
                                <button onclick="sendBulkEmail()" class="success"><i class="fas fa-paper-plane"></i> Enviar Emails em Lote</button>
                            </div>
                        </div>
                        <div id="cobrancaContainer"></div>
                    </div>
                    
                    <div class="email-template">
                        <h3>Modelo de Email de Cobrança</h3>
                        <div class="email-subject">Assunto: [ASSUNTO]</div>
                        <div class="email-body" id="emailPreview">
    [CORPO DO EMAIL]
                        </div>
                        <div class="email-footer">
                            Este email será enviado automaticamente pelo sistema de gestão de demandas.
                        </div>
                    </div>
                </div>
            </div>

            <div id="exportar" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-download"></i> Exportar Dados</h2>
                    <p>Exporte todas as demandas do sistema para análise ou backup.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportFormat">Formato:</label>
                            <select id="exportFormat">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="exportarDemandas()"><i class="fas fa-download"></i> Exportar Todas as Demandas</button>
                </div>

                <div class="card">
                    <h2><i class="fas fa-upload"></i> Importar Dados</h2>
                    <p>Importe demandas a partir de um arquivo JSON. As demandas com o mesmo nome e TAG serão substituídas.</p>
                    <div class="form-group">
                        <label for="importFile">Selecione o arquivo JSON:</label>
                        <input type="file" id="importFile" accept=".json">
                    </div>
                    <button onclick="importarDemandas()"><i class="fas fa-file-import"></i> Importar Demandas</button>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="resolucaoModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('resolucaoModal')">&times;</span>
        <h2 id="resolucaoModalTitle">Resolver Demanda</h2>
        <form id="resolucaoForm">
            <div class="form-group">
                <label for="resolucaoComentarios">Comentários sobre a resolução:</label>
                <textarea id="resolucaoComentarios" rows="4" required placeholder="Descreva como a demanda foi resolvida, quais foram os desafios, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="resolucaoAnexos">Anexar Documentos/Imagens:</label>
                <input type="file" id="resolucaoAnexos" multiple>
                <div id="anexosList" class="file-list"></div>
            </div>
            <div class="form-group">
                <button type="submit" class="success"><i class="fas fa-save"></i> Salvar Resolução</button>
                <button type="button" class="secondary" onclick="closeModal('resolucaoModal')"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="reprovacaoModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('reprovacaoModal')">&times;</span>
        <h2><i class="fas fa-times-circle"></i> Reprovar Demanda</h2>
        <form id="reprovacaoForm">
            <div class="form-group">
                <label for="motivoReprovacao">Motivo da Reprovação:</label>
                <textarea id="motivoReprovacao" rows="4" required placeholder="Por favor, justifique o motivo da reprovação..."></textarea>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="extendDeadline" onchange="toggleDeadlineExtension()">
                <label for="extendDeadline">Estender prazo para nova data</label>
            </div>
            <div id="deadlineExtension" class="deadline-extension">
                <div class="form-group">
                    <label for="novaDataLimite">Nova Data Limite:</label>
                    <input type="date" id="novaDataLimite">
                </div>
            </div>
            <div class="form-group">
                <button type="submit" class="danger"><i class="fas fa-times"></i> Reprovar Demanda</button>
                <button type="button" class="secondary" onclick="closeModal('reprovacaoModal')"><i class="fas fa-arrow-left"></i> Voltar</button>
            </div>
        </form>
    </div>
</div>

<div id="reassignModal" class="reassign-modal">
    <div class="reassign-modal-content">
        <span class="close-btn" onclick="closeModal('reassignModal')">&times;</span>
        <h2><i class="fas fa-user-plus"></i> Reatribuir Demanda</h2>
        <form id="reassignForm">
            <div class="form-group">
                <label for="reassignTo">Atribuir para:</label>
                <select id="reassignTo" required>
                    <option value="">Selecione um funcionário</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reassignReason">Motivo da reatribuição:</label>
                <textarea id="reassignReason" rows="3" required placeholder="Explique o motivo da reatribuição..."></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="success"><i class="fas fa-save"></i> Reatribuir</button>
                <button type="button" class="secondary" onclick="closeModal('reassignModal')"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="extendDeadlineModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('extendDeadlineModal')">&times;</span>
        <h2><i class="fas fa-calendar-plus"></i> Estender Prazo da Demanda</h2>
        <form id="extendDeadlineForm">
            <div class="form-group">
                <label for="extendReason">Motivo da extensão:</label>
                <textarea id="extendReason" rows="3" required placeholder="Explique o motivo da extensão de prazo..."></textarea>
            </div>
            <div class="form-group">
                <label for="novaDataLimiteExt">Nova Data Limite:</label>
                <input type="date" id="novaDataLimiteExt" required>
            </div>
            <div class="form-group">
                <button type="submit" class="success"><i class="fas fa-save"></i> Estender Prazo</button>
                <button type="button" class="secondary" onclick="closeModal('extendDeadlineModal')"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('noteModal')">&times;</span>
        <h2 id="noteModalTitle">Nova Anotação</h2>
        <form id="noteForm">
            <div class="form-group">
                <label for="noteTitle">Título:</label>
                <input type="text" id="noteTitle" required placeholder="Dê um título para sua anotação">
            </div>
            <div class="form-group">
                <label for="noteContent">Conteúdo:</label>
                <textarea id="noteContent" rows="6" required placeholder="Digite sua anotação..."></textarea>
            </div>
            <div class="form-group">
                <label for="noteColor">Cor:</label>
                <select id="noteColor">
                    <option value="#3498db">Azul</option>
                    <option value="#2ecc71">Verde</option>
                    <option value="#e74c3c">Vermelho</option>
                    <option value="#f39c12">Amarelo</option>
                    <option value="#9b59b6">Roxo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="noteAssignTo">Atribuir a:</label>
                <select id="noteAssignTo">
                    <option value="">Não atribuir</option>
                </select>
            </div>
            <div class="form-group">
                <button type="submit" class="success"><i class="fas fa-save"></i> Salvar Anotação</button>
                <button type="button" id="transcribeBtn" class="secondary"><i class="fas fa-microphone"></i> Transcrever</button>
                <button type="button" class="secondary" onclick="closeModal('noteModal')"><i class="fas fa-times"></i> Cancelar</button>
            </div>
            <div id="transcriptionArea" class="transcription-area">
                <p>Clique no botão "Transcrever" para começar a transcrever sua fala para texto.</p>
            </div>
        </form>
    </div>
</div>

<div id="notification" class="notification">
    <h4><i class="fas fa-bell"></i> <span id="notificationTitle">Notificação</span></h4>
    <p id="notificationMessage">Mensagem da notificação</p>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
        <h2 id="modalTitle">Detalhes da Demanda</h2>
        <div id="modalBody">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>

<button class="floating-action-btn" onclick="quickAction()">
    <i class="fas fa-plus"></i>
</button>

<script>
    // Variáveis globais
  const usuarios = [
    { id: 1, nome: 'Ranielly Miranda De Souza', email: 'ranielly-s@zaminebrasil.com', nivel: 'Senior', pontos: 450, conquistas: ['star', 'fire', 'gold'], senha: '123456', role: 'funcionario' },
    { id: 2, nome: 'Girlene da Silva Nogueira', email: 'girlene-n@zaminebrasil.com', nivel: 'Pleno', pontos: 380, conquistas: ['star', 'silver'], senha: '123456', role: 'funcionario' },
    { id: 3, nome: 'Rafaela Cristine da Silva Martins', email: 'rafaela-m@zaminebrasil.com', nivel: 'Senior', pontos: 520, conquistas: ['star', 'fire', 'gold'], senha: '123456', role: 'funcionario' },
    { id: 5, nome: 'Marcos Antônio Lino Rosa', email: 'marcos-a@zaminebrasil.com', nivel: 'Junior', pontos: 280, conquistas: ['star'], senha: '123456', role: 'funcionario' },
    { id: 6, nome: 'Marcos Paulo Moraes Borges', email: 'marcos-b@zaminebrasil.com', nivel: 'Pleno', pontos: 410, conquistas: ['star', 'silver'], senha: '123456', role: 'funcionario' },
    { id: 7, nome: 'Marcelo Goncalves de Paula', email: 'marcelo-p@zaminebrasil.com', nivel: 'Senior', pontos: 480, conquistas: ['star', 'fire', 'gold'], senha: '123456', role: 'funcionario' },
    { id: 8, nome: 'Higor Ataides Macedo', email: 'higor-a@zaminebrasil.com', nivel: 'Junior', pontos: 250, conquistas: ['star'], senha: '123456', role: 'funcionario' },
    { id: 9, nome: 'Weslley Ferreira de Siqueira', email: 'weslley-f@zaminebrasil.com', nivel: 'Pleno', pontos: 360, conquistas: ['star', 'silver'], senha: '123456', role: 'funcionario' },
    { id: 10, nome: 'Jadson Joao Romano', email: 'jadson-r@zaminebrasil.com', nivel: 'Senior', pontos: 440, conquistas: ['star', 'fire', 'gold'], senha: 'admin123', role: 'gestor' }, // Alterado para gestor
    { id: 11, nome: 'Charles de Andrade', email: 'charles-a@zaminebrasil.com', nivel: 'Pleno', pontos: 390, conquistas: ['star', 'silver'], senha: '123456', role: 'funcionario' },
    { id: 12, nome: 'Jose Carlos Rodrigues de Santana', email: 'jose-s@zaminebrasil.com', nivel: 'Junior', pontos: 220, conquistas: ['star'], senha: '123456', role: 'funcionario' },
    { id: 13, nome: 'Max Henrique Araujo', email: 'max-r@zaminebrasil.com', nivel: 'Pleno', pontos: 340, conquistas: ['star', 'silver'], senha: '123456', role: 'funcionario' },
    { id: 14, nome: 'Emerson Luiz Alexandre', email: 'emerson-a@zaminebrasil.com', nivel: 'Senior', pontos: 460, conquistas: ['star', 'fire', 'gold'], senha: 'admin123', role: 'gestor' }, // Novo gestor adicionado
    { id: 99, nome: 'Gestor do Sistema', email: 'wallysson-s@zaminebrasil.com', nivel: 'Administrador', pontos: 999, conquistas: ['star', 'fire', 'gold', 'crown'], senha: 'admin123', role: 'gestor' },
    { id: 100, nome: 'Wallysson Diego Santiago Santos', email: 'wallysson-s@zaminebrasil.com', nivel: 'Coordenador', pontos: 999, conquistas: ['star', 'fire', 'gold', 'crown'], senha: 'admin123', role: 'gestor' },
    { id: 101, nome: 'Julio Cesar Sanches', email: 'julio-s@zaminebrasil.com', nivel: 'Gerente', pontos: 999, conquistas: ['star', 'fire', 'gold', 'crown'], senha: 'admin123', role: 'gestor' }
];

    let usuarioLogado = null;
    let todasDemandas = [];
    let timerInterval;
    let charts = {};
    let filtroFuncionarioAtual = 'todos';
    let userNotifications = []; 
    let pendingAction = null;
    let selectedOverdueItems = [];
    let demandaResolucaoAtual = null;
    let demandaAtribuicaoAtual = null;
    let selectedUsers = [];
    let notes = [];
    let feedbacks = [];
    let mindmapNodes = [];
    let isTranscribing = false;
    let recognition = null;
    let selectedOverdueDemands = new Set();

    const SERVER_URL = window.location.origin;
    let serverConnected = false;

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        carregarUsuariosNoSelect();
        inicializarEventListeners();
        verificarStatusServidor();
        
        const sessao = sessionStorage.getItem('usuarioLogado');
        if (sessao) {
            usuarioLogado = JSON.parse(sessao);
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            configurarInterfaceUsuario();
            inicializarSistemaPrincipal();
        }
        
        // Inicializar filtros de mês e ano
        inicializarFiltrosData();
        
        // Inicializar reconhecimento de fala
        inicializarReconhecimentoFala();
    });
// Função global para aprovar demanda
function aprovarDemanda(id, nomeFuncionario) {
    if (!confirm('Tem certeza que deseja aprovar esta demanda?')) return;
    
    const demanda = todasDemandas.find(d => d.id === id);
    if (demanda) {
        const dadosAtualizados = {
            status: 'aprovada',
            dataConclusao: new Date().toISOString()
        };
        
        atualizarDemandaNoServidor(id, dadosAtualizados).then(sucesso => {
            if (sucesso) {
                carregarDadosDoServidor().then(() => {
                    showNotification('success', 'Demanda Aprovada', `Demanda de ${nomeFuncionario} foi aprovada com sucesso!`);
                    
                    // Definir gestores por local
                    const gestoresPorLocal = {
                        'R&D': ['jadson-r@zaminebrasil.com', 'emerson-a@zaminebrasil.com'],
                        'Lundin': ['wallysson-s@zaminebrasil.com']
                    };
                    
                    // Obter gestores específicos para o local da demanda
                    const gestoresLocal = gestoresPorLocal[demanda.local] || [];
                    
                    const funcionario = usuarios.find(u => u.id === demanda.funcionarioId);
                    if (funcionario) {
                        const assunto = encodeURIComponent(`Sua Demanda Foi Aprovada: ${demanda.nomeDemanda || demanda.descricao}`);
                        const corpo = encodeURIComponent(`Prezado(a) ${nomeFuncionario},\n\nSua demanda foi analisada e aprovada.\n\n--- Detalhes ---\nNome: ${demanda.nomeDemanda || demanda.descricao}\nTAG: ${demanda.tag}\nLocal: ${demanda.local}\n\nParabéns pelo excelente trabalho!\n\nAtenciosamente,\nGestão`);
                        
                        // Preparar emails
                        let emailsPara = funcionario.email;
                        let emailsCc = '';
                        
                        // Adicionar gestores do local em CC
                        if (gestoresLocal.length > 0) {
                            emailsCc = gestoresLocal.join(',');
                        }
                        
                        let mailtoLink = `mailto:${emailsPara}?subject=${assunto}&body=${corpo}`;
                        if (emailsCc) {
                            mailtoLink += `&cc=${emailsCc}`;
                        }
                        window.open(mailtoLink, '_blank');
                        
                        if (userNotifications) {
                            addUserNotification('success', 'Demanda Aprovada', `Sua demanda "${demanda.nomeDemanda}" foi aprovada!`, { tag: demanda.tag });
                        }
                    }
                    
                    // Notificar também os atribuídos
                    if (demanda.atribuidos && Array.isArray(demanda.atribuidos)) {
                        demanda.atribuidos.forEach(atribuido => {
                            if (atribuido.id !== demanda.funcionarioId) {
                                const usuarioAtribuido = usuarios.find(u => u.id === atribuido.id);
                                if (usuarioAtribuido && userNotifications) {
                                    addUserNotification('success', 'Demanda Aprovada', 
                                        `A demanda "${demanda.nomeDemanda}" foi aprovada!`, 
                                        { tag: demanda.tag }
                                    );
                                }
                            }
                        });
                    }
                    
                    renderizarTodasAsAbas();
                });
            }
        });
    }
}
    // Função para inicializar o reconhecimento de fala
    function inicializarReconhecimentoFala() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = function(event) {
                const transcriptionArea = document.getElementById('transcriptionArea');
                const noteContent = document.getElementById('noteContent');
                
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    }
                }
                
                if (finalTranscript) {
                    // Adicionar o texto transcrito diretamente ao campo de conteúdo
                    noteContent.value += finalTranscript;
                    transcriptionArea.innerHTML = `<p><strong>Transcrevendo:</strong> ${finalTranscript}</p>`;
                    transcriptionArea.classList.add('active');
                }
            };

            recognition.onerror = function(event) {
                console.error('Erro no reconhecimento de fala:', event.error);
                const transcriptionArea = document.getElementById('transcriptionArea');
                transcriptionArea.innerHTML = `<p>Erro no reconhecimento de fala: ${event.error}</p>`;
                transcriptionArea.classList.remove('active');
                isTranscribing = false;
                document.getElementById('transcribeBtn').innerHTML = '<i class="fas fa-microphone"></i> Transcrever';
            };

            recognition.onend = function() {
                isTranscribing = false;
                document.getElementById('transcribeBtn').innerHTML = '<i class="fas fa-microphone"></i> Transcrever';
                const transcriptionArea = document.getElementById('transcriptionArea');
                transcriptionArea.innerHTML = '<p>Transcrição concluída.</p>';
                setTimeout(() => {
                    transcriptionArea.classList.remove('active');
                }, 2000);
            };
        } else {
            console.log('Reconhecimento de fala não suportado neste navegador');
            document.getElementById('transcribeBtn').style.display = 'none';
        }
    }

    // Função para iniciar/parar a transcrição
    function toggleTranscription() {
        if (!recognition) {
            showNotification('error', 'Reconhecimento de Fala', 'Seu navegador não suporta reconhecimento de fala.');
            return;
        }

        const transcriptionArea = document.getElementById('transcriptionArea');
        const transcribeBtn = document.getElementById('transcribeBtn');

        if (isTranscribing) {
            recognition.stop();
            isTranscribing = false;
            transcribeBtn.innerHTML = '<i class="fas fa-microphone"></i> Transcrever';
        } else {
            recognition.start();
            isTranscribing = true;
            transcribeBtn.innerHTML = '<i class="fas fa-stop"></i> Parar';
            transcriptionArea.innerHTML = '<p><strong>Ouvindo...</strong> Fale agora para transcrever.</p>';
            transcriptionArea.classList.add('active');
        }
    }

    // Função para inicializar filtros de mês e ano
    function inicializarFiltrosData() {
        const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const anoAtual = new Date().getFullYear();
        
        // Adicionar anos de 2023 até o ano atual + 1
        const anos = [];
        for (let ano = 2023; ano <= anoAtual + 1; ano++) {
            anos.push(ano);
        }
        
        // Seletores para abas que precisam de filtros de mês e ano
        const selects = [
            { month: 'pendentesMonthFilter', year: 'pendentesYearFilter' },
            { month: 'analiseMonthFilter', year: 'analiseYearFilter' },
            { month: 'atrasadasMonthFilter', year: 'atrasadasYearFilter' },
            { month: 'aprovadasMonthFilter', year: 'aprovadasYearFilter' },
            { month: 'colabMonthFilter', year: 'colabYearFilter' },
            { month: 'rankingMonthFilter', year: 'rankingYearFilter' },
            { month: 'notesMonthFilter', year: 'notesYearFilter' }
        ];
        
        selects.forEach(select => {
            // Preencher filtro de mês
            const monthSelect = document.getElementById(select.month);
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">Todos os meses</option>';
                
                for (let i = 0; i < 12; i++) {
                    const option = document.createElement('option');
                    option.value = String(i + 1).padStart(2, '0');
                    option.textContent = meses[i];
                    monthSelect.appendChild(option);
                }
            }
            
            // Preencher filtro de ano
            const yearSelect = document.getElementById(select.year);
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">Todos os anos</option>';
                
                anos.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    yearSelect.appendChild(option);
                });
            }
        });
    }

    // Função para normalizar dados de uma demanda
    function normalizarDadosDemanda(demanda) {
        if (!demanda) return demanda;

        // Garante que 'diasSemana' seja um array
        if (typeof demanda.diasSemana === 'string') {
            try {
                demanda.diasSemana = JSON.parse(demanda.diasSemana);
            } catch (e) {
                demanda.diasSemana = [];
            }
        } else if (!Array.isArray(demanda.diasSemana)) {
            demanda.diasSemana = [];
        }

        // Garante que 'atribuidos' seja um array
        if (typeof demanda.atribuidos === 'string') {
            try {
                demanda.atribuidos = JSON.parse(demanda.atribuidos);
            } catch (e) {
                demanda.atribuidos = [];
            }
        } else if (!Array.isArray(demanda.atribuidos)) {
            demanda.atribuidos = [];
        }

        // Garante que 'isRotina' seja um booleano
        demanda.isRotina = Boolean(demanda.isRotina);

        return demanda;
    }

    // Funções de notificação
    function toggleNotificationsDropdown() {
        const dropdown = document.getElementById('notificationsDropdown');
        dropdown.classList.toggle('show');
    }

    function salvarNotificacoesNoStorage() {
        if (!usuarioLogado) return;
        const storageKey = `userNotifications_${usuarioLogado.id}`;
        localStorage.setItem(storageKey, JSON.stringify(userNotifications));
    }

    function carregarNotificacoesDoStorage() {
        if (!usuarioLogado) {
            userNotifications = [];
            return;
        }
        const storageKey = `userNotifications_${usuarioLogado.id}`;
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            try {
                userNotifications = JSON.parse(saved);
            } catch (e) {
                console.error('Erro ao carregar notificações do usuário:', e);
                userNotifications = [];
            }
        } else {
            userNotifications = [];
        }
        renderUserNotifications();
        updateNotificationCount();
    }

    function addUserNotification(type, title, message, data = {}) {
        const notification = {
            id: Date.now() + Math.random(),
            type: type,
            title: title,
            message: message,
            date: new Date(),
            priority: false,
            ...data
        };
        userNotifications.unshift(notification);
        renderUserNotifications();
        updateNotificationCount();
        salvarNotificacoesNoStorage();
    }

    function markAsRead(id) {
        userNotifications = userNotifications.filter(n => n.id !== id);
        renderUserNotifications();
        updateNotificationCount();
        salvarNotificacoesNoStorage();
    }

    function togglePriority(id) {
        const notification = userNotifications.find(n => n.id === id);
        if (notification) {
            notification.priority = !notification.priority;
            renderUserNotifications();
            salvarNotificacoesNoStorage();
        }
    }

    function clearAllNotifications() {
        userNotifications = [];
        renderUserNotifications();
        updateNotificationCount();
        salvarNotificacoesNoStorage();
    }

    function updateNotificationCount() {
        const countElement = document.getElementById('notificationCount');
        if (countElement) {
            countElement.textContent = userNotifications.length;
            countElement.style.display = userNotifications.length > 0 ? 'inline-block' : 'none';
        }
    }
    
    function renderUserNotifications() {
        const listContainer = document.getElementById('notificationsList');
        if (!listContainer) return;

        if (userNotifications.length === 0) {
            listContainer.innerHTML = '<p style="padding: 15px; text-align: center; color: #aaa;">Nenhuma notificação</p>';
            return;
        }

        listContainer.innerHTML = userNotifications.map(not => `
            <div class="notification-item ${not.priority ? 'priority-notification' : ''}" onclick="goToDemandaFromNotification('${not.tag || ''}')">
                <h4>${not.title} ${not.priority ? '<i class="fas fa-star" style="color: gold;"></i>' : ''}</h4>
                <p>${not.message}</p>
                <small>${formatDate(not.date)}</small>
                <div class="notification-actions">
                    <button class="clear-notifications-btn" onclick="event.stopPropagation(); markAsRead(${not.id})" title="Marcar como lida">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="priority-btn" onclick="event.stopPropagation(); togglePriority(${not.id})" title="${not.priority ? 'Remover prioridade' : 'Marcar como prioridade'}">
                        <i class="fas fa-star" style="${not.priority ? 'color: gold;' : ''}"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notificationsDropdown');
        const button = event.target.closest('button[onclick="toggleNotificationsDropdown()"]');
        if (!button && !dropdown.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });

    // Verificação de status do servidor
    async function verificarStatusServidor() {
        const statusElement = document.getElementById('serverStatus');
        const statusText = document.getElementById('serverStatusText');
        
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`);
            if (response.ok) {
                serverConnected = true;
                statusElement.className = 'server-status connected';
                statusText.textContent = 'Servidor conectado';
            } else {
                throw new Error('Servidor não respondeu');
            }
        } catch (error) {
            serverConnected = false;
            statusElement.className = 'server-status disconnected';
            statusText.textContent = 'Servidor desconectado';
        }
        
        setTimeout(verificarStatusServidor, 30000);
    }

    // Carregar usuários no select
    function carregarUsuariosNoSelect() {
        const userSelect = document.getElementById('userSelect');
        if (userSelect) {
            usuarios.forEach(usuario => {
                const option = new Option(usuario.nome, usuario.id);
                userSelect.add(option);
            });
        }
    }

    // Funções para alternar entre as telas de login, esqueci senha e cadastro
    function showLogin() {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('forgotPasswordContainer').style.display = 'none';
        document.getElementById('registerContainer').style.display = 'none';
    }

    function showForgotPassword() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('forgotPasswordContainer').style.display = 'flex';
        document.getElementById('registerContainer').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('forgotPasswordContainer').style.display = 'none';
        document.getElementById('registerContainer').style.display = 'flex';
    }

    // Sistema de Login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('userSelect').value;
        const password = document.getElementById('passwordInput').value;
        
        const usuario = usuarios.find(u => u.id == userId);
        
        if (!usuario) {
            showNotification('error', 'Erro de Login', 'Usuário não encontrado');
            return;
        }
        
        if (usuario.senha !== password) {
            showNotification('error', 'Erro de Login', 'Senha incorreta');
            return;
        }
        
        usuarioLogado = usuario;
        sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
        
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        
        configurarInterfaceUsuario();
        inicializarSistemaPrincipal();
        
        carregarNotificacoesDoStorage();
        
        showNotification('success', 'Bem-vindo!', `Olá, ${usuario.nome}! Você está logado como ${usuario.role === 'gestor' ? 'Gestor' : 'Funcionário'}`);
    });

    // Formulário de esqueci senha
    document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('forgotEmail').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!email || !newPassword || !confirmPassword) {
            showNotification('error', 'Erro', 'Por favor, preencha todos os campos');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showNotification('error', 'Erro', 'As senhas não coincidem');
            return;
        }
        
        // Enviar email para max-r@zaminebrasil.com
        const assunto = encodeURIComponent('Solicitação de Redefinição de Senha');
        const corpo = encodeURIComponent(`Prezado Administrador,\n\nO usuário com email ${email} solicitou a redefinição de sua senha.\n\nNova senha solicitada: ${newPassword}\n\nPor favor, atualize a senha deste usuário no sistema.\n\nAtenciosamente,\nSistema de Gestão de Demandas`);
        
        window.open(`mailto:max-r@zaminebrasil.com?subject=${assunto}&body=${corpo}`, '_blank');
        
        showNotification('success', 'Email Enviado', 'Um email foi enviado para o administrador com a nova senha solicitada.');
        
        // Limpar formulário
        document.getElementById('forgotEmail').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Voltar para a tela de login
        setTimeout(() => {
            showLogin();
        }, 2000);
    });

    // Formulário de cadastro
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nome = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const senha = document.getElementById('registerPassword').value;
        const role = document.getElementById('registerRole').value;
        
        if (!nome || !email || !senha || !role) {
            showNotification('error', 'Erro', 'Por favor, preencha todos os campos');
            return;
        }
        
        // Enviar email para max-r@zaminebrasil.com
        const assunto = encodeURIComponent('Solicitação de Cadastro de Usuário');
        const corpo = encodeURIComponent(`Prezado Administrador,\n\nFoi solicitado o cadastro de um novo usuário com os seguintes dados:\n\nNome: ${nome}\nEmail: ${email}\nTipo de Usuário: ${role}\nSenha: ${senha}\n\nPor favor, adicione este usuário ao sistema.\n\nAtenciosamente,\nSistema de Gestão de Demandas`);
        
        window.open(`mailto:max-r@zaminebrasil.com?subject=${assunto}&body=${corpo}`, '_blank');
        
        showNotification('success', 'Solicitação Enviada', 'Sua solicitação de cadastro foi enviada para o administrador.');
        
        // Limpar formulário
        document.getElementById('registerName').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerRole').value = '';
        
        // Voltar para a tela de login
        setTimeout(() => {
            showLogin();
        }, 2000);
    });

    // Configurar interface do usuário
    function configurarInterfaceUsuario() {
        const userBadge = document.getElementById('userBadge');
        const userName = document.getElementById('userName');
        
        if (userBadge && userName) {
            userName.textContent = usuarioLogado.nome;
            
            if (usuarioLogado.role === 'gestor') {
                userBadge.classList.add('gestor');
                userBadge.innerHTML = '<i class="fas fa-user-shield"></i> <span>' + usuarioLogado.nome + ' (Gestor)</span>';
                document.getElementById('gestorTab').style.display = 'block';
                document.getElementById('gestorTab2').style.display = 'block';
                document.getElementById('gestorTab4').style.display = 'block';
                document.getElementById('gestorTab5').style.display = 'block';
                document.getElementById('gestorActions2').style.display = 'flex';
                document.getElementById('gestorActions3').style.display = 'flex';
                document.getElementById('exportRankingBtn').style.display = 'inline-block';
            } else {
                userBadge.innerHTML = '<i class="fas fa-user"></i> <span>' + usuarioLogado.nome + '</span>';
            }
        }
    }

    // Inicializar sistema principal
    async function inicializarSistemaPrincipal() {
        carregarFuncionariosNosSelect();
        await carregarDadosDoServidor();
        inicializarImportacaoJSON();
        carregarAnotacoes();
        carregarMindmapLayout();
        atualizarDashboard();
        atualizarRanking();
        inicializarGraficos();
        
        timerInterval = setInterval(atualizarTemposRestantes, 1000);
        verificarLembretes();
        
        gerarNotificacoesAoLogar();
    }

    // Logout
    function logout() {
        if (confirm('Tem certeza que deseja sair do sistema?')) {
            salvarNotificacoesNoStorage();
            salvarAnotacoes();
            sessionStorage.removeItem('usuarioLogado');
            usuarioLogado = null;
            location.reload();
        }
    }

    // Carregar funcionários nos selects
   // Carregar funcionários nos selects
// Carregar funcionários nos selects
// Carregar funcionários nos selects
// Carregar funcionários nos selects
function carregarFuncionariosNosSelect() {
    const selects = [
        'filtroFuncionario', 
        'cobrancaFuncionario', 
        'colabFuncFilter', 
        'analiseFuncFilter', 
        'atrasadasFuncFilter', 
        'aprovadasFuncFilter', 
        'reassignTo', 
        'noteAssignTo', 
        'mindmapFuncFilter'
    ];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '';
            
            if (selectId === 'filtroFuncionario' || 
                selectId === 'colabFuncFilter' || 
                selectId === 'mindmapFuncFilter' || 
                selectId === 'analiseFuncFilter' || 
                selectId === 'atrasadasFuncFilter' || 
                selectId === 'aprovadasFuncFilter') {
                const defaultOption = new Option('Todos os Funcionários', 'todos');
                select.add(defaultOption);
            } else if (selectId === 'cobrancaFuncionario') {
                const defaultOption = new Option('Todos os Funcionários com Demandas Atrasadas', 'todos');
                select.add(defaultOption);
            } else if (selectId === 'reassignTo') {
                // Alterado para incluir funcionários e gestores
                const defaultOption = new Option('Selecione um funcionário ou gestor', '');
                select.add(defaultOption);
            } else if (selectId === 'noteAssignTo') {
                const defaultOption = new Option('Não atribuir', '');
                select.add(defaultOption);
            }

            // Filtrar usuários com base no tipo de select
            let usuariosParaMostrar = usuarios;
            if (selectId === 'reassignTo') {
                // Para reatribuição, mostrar funcionários e gestores
                usuariosParaMostrar = usuarios.filter(u => u.role === 'funcionario' || u.role === 'gestor');
            } else if (selectId === 'noteAssignTo') {
                // Para notas, mostrar todos os usuários
                usuariosParaMostrar = usuarios;
            } else {
                // Para outros filtros, mostrar apenas funcionários
                usuariosParaMostrar = usuarios.filter(u => u.role === 'funcionario');
            }

            usuariosParaMostrar.forEach(usuario => {
                const option = new Option(usuario.nome, usuario.id);
                select.add(option);
            });
        }
    });
    
    // Configurar separadamente o filtro de locais para apenas Lundin e R&D
    const localSelects = ['colabLocalFilter', 'mindmapLocalFilter'];
    
    localSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '';
            
            const defaultOption = new Option('Todos os Locais', 'todos');
            select.add(defaultOption);
            
            const optionLundin = new Option('Lundin', 'Lundin');
            select.add(optionLundin);
            
            const optionRD = new Option('R&D', 'R&D');
            select.add(optionRD);
        }
    });
    
    inicializarCampoMultiSelect();
}
    // Inicializar campo de seleção múltipla
   // Inicializar campo de seleção múltipla
function inicializarCampoMultiSelect() {
    const dropdown = document.getElementById('atribuidoADropdown');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    // Incluir tanto funcionários quanto gestores
    usuarios.filter(u => u.role === 'funcionario' || u.role === 'gestor').forEach(usuario => {
        const option = document.createElement('div');
        option.className = 'multi-select-option';
        
        // Adicionar ícone para diferenciar gestores
        const icon = usuario.role === 'gestor' ? '<i class="fas fa-user-shield"></i> ' : '<i class="fas fa-user"></i> ';
        const label = usuario.role === 'gestor' ? `${usuario.nome} (Gestor)` : usuario.nome;
        
        option.innerHTML = `
            <input type="checkbox" id="user_${usuario.id}" value="${usuario.id}">
            <label for="user_${usuario.id}">${icon}${label}</label>
        `;
        
        option.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            }
            updateSelectedUsers();
        });
        
        dropdown.appendChild(option);
    });
}
    // Alternar dropdown de seleção múltipla
    function toggleMultiSelect(id) {
        const dropdown = document.getElementById(id + 'Dropdown');
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                d.style.display = 'none';
            });
            dropdown.style.display = 'block';
        }
    }

    // Atualizar usuários selecionados
    function updateSelectedUsers() {
        selectedUsers = [];
        const checkboxes = document.querySelectorAll('#atribuidoADropdown input[type="checkbox"]:checked');
        
        checkboxes.forEach(checkbox => {
            const userId = parseInt(checkbox.value);
            const usuario = usuarios.find(u => u.id === userId);
            if (usuario) {
                selectedUsers.push(usuario);
            }
        });
        
        const display = document.getElementById('atribuidoADisplay');
        if (selectedUsers.length === 0) {
            display.innerHTML = '<span style="color: #999;">Clique para selecionar funcionários...</span>';
        } else {
            display.innerHTML = selectedUsers.map(user => 
                `<span class="selected-item">${user.nome} <i class="fas fa-times" onclick="removeUser(${user.id})"></i></span>`
            ).join('');
        }
    }

    // Remover usuário da seleção
    function removeUser(userId) {
        const checkbox = document.getElementById(`user_${userId}`);
        if (checkbox) {
            checkbox.checked = false;
            updateSelectedUsers();
        }
    }

    // Carregar dados do servidor
    async function carregarDadosDoServidor() {
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`);
            if (response.ok) {
                const demandasDoServidor = await response.json();
                
                // Normaliza os dados recebidos
                const demandasNormalizadas = demandasDoServidor.map(demanda => normalizarDadosDemanda(demanda));
                
                demandasNormalizadas.forEach(demanda => {
                    if (!todasDemandas.find(d => d.id === demanda.id)) {
                        todasDemandas.push(demanda);
                    }
                });
                
            } else {
                showNotification('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor.');
            }
        } catch (error) {
            console.error('Erro de conexão com o servidor:', error);
            showNotification('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor.');
        }
        
        renderizarDemandas();
        renderizarCobranca();
        atualizarBadges();
        atualizarMindmap();
    }

    // Salvar demanda no servidor
    async function salvarDemandaNoServidor(demanda) {
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(demanda)
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao salvar demanda no servidor:', error);
            showNotification('error', 'Erro ao Salvar', 'Não foi possível salvar a demanda no servidor.');
        }
        return false;
    }

    // Atualizar demanda no servidor
    async function atualizarDemandaNoServidor(id, dadosAtualizados) {
        try {
            const demandaExistente = todasDemandas.find(d => d.id === id);
            if (!demandaExistente) return false;
            const dadosCompletos = { ...demandaExistente, ...dadosAtualizados };

            const response = await fetch(`${SERVER_URL}/api/demandas/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosCompletos)
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao atualizar demanda no servidor:', error);
            showNotification('error', 'Erro ao Atualizar', 'Não foi possível atualizar a demanda no servidor.');
        }
        return false;
    }

    // Deletar demanda do servidor
    async function deletarDemandaDoServidor(id) {
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao deletar demanda do servidor:', error);
            showNotification('error', 'Erro ao Deletar', 'Não foi possível deletar a demanda no servidor.');
        }
        return false;
    }

    // Atualizar badges
    function atualizarBadges() {
        const pendentes = getDemandasParaUsuarioLogado().filter(d => d.status === 'pendente' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'atribuida_pendente_aceitacao').length;
        const analise = getDemandasParaUsuarioLogado().filter(d => d.status === 'finalizado_pendente_aprovacao').length;
        const atrasadas = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        }).length;
        const concluidas = getDemandasParaUsuarioLogado().filter(d => d.status === 'aprovada').length;
        const colabPendentes = getDemandasDosColaboradores().filter(d => d.status === 'pendente' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'atribuida_pendente_aceitacao').length;

        updateBadge('pendingBadge', pendentes);
        updateBadge('analysisBadge', analise);
        updateBadge('overdueBadge', atrasadas);
        updateBadge('completedBadge', concluidas);
        updateBadge('colabPendingBadge', colabPendentes);
    }

    function updateBadge(badgeId, count) {
        const badge = document.getElementById(badgeId);
        if (badge) {
            if (badgeId === 'dashboardBadge') return;
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Gerar notificações ao logar
    function gerarNotificacoesAoLogar() {
        if (!usuarioLogado || usuarioLogado.role !== 'funcionario') return;

        getDemandasParaUsuarioLogado().forEach(demanda => {
            const isAtribuidoAMim = demanda.atribuidos && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
            const isDono = demanda.funcionarioId === usuarioLogado.id;
            
            if (isAtribuidoAMim && !isDono && demanda.status !== 'aprovada') {
                const notificacaoExistente = userNotifications.find(n => n.tag === demanda.tag && n.title.includes('atribuiu'));
                if (!notificacaoExistente) {
                    const nomeTarefa = demanda.nomeDemanda || demanda.descricao || 'uma tarefa';
                    addUserNotification('info', 'Nova Tarefa Atribuída', `${demanda.nomeFuncionario} atribuiu uma tarefa a você: "${nomeTarefa}".`, { tag: demanda.tag });
                }
            }
        });
    }

    // Navegar para demanda a partir da notificação
    function goToDemandaFromNotification(tag) {
        if (!tag) return;

        document.getElementById('notificationsDropdown').classList.remove('show');
        switchTab('analise');

        setTimeout(() => {
            const allDemandaItems = document.querySelectorAll('#analiseContainer .demanda-item');
            for (const item of allDemandaItems) {
                if (item.innerHTML.includes(`TAG: ${tag}`)) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    item.style.transition = 'background-color 0.5s';
                    item.style.backgroundColor = 'rgba(255, 193, 7, 0.5)';
                    setTimeout(() => {
                        item.style.backgroundColor = '';
                    }, 2500);
                    break;
                }
            }
        }, 300);
    }

    // Obter demandas para o usuário logado
    // Obter demandas para o usuário logado
function getDemandasParaUsuarioLogado() {
    if (!usuarioLogado) return [];
    
    // Para gestores, mostrar apenas demandas que não foram atribuídas a outros
    if (usuarioLogado.role === 'gestor') {
        return todasDemandas.filter(demanda => {
            // Se a demanda foi criada pelo gestor E não foi atribuída a ninguém OU foi atribuída ao próprio gestor
            const eCriador = demanda.funcionarioId === usuarioLogado.id;
            const naoAtribuida = !demanda.atribuidos || demanda.atribuidos.length === 0;
            const atribuidaAMim = Array.isArray(demanda.atribuidos) && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
            
            // Mostrar se: (é criador E não foi atribuída) OU (foi atribuída a mim)
            return (eCriador && naoAtribuida) || atribuidaAMim;
        });
    }
    
    // Para funcionários, as demandas que eles criaram ou que foram atribuídas a eles
    if (usuarioLogado.role === 'funcionario') {
        return todasDemandas.filter(demanda => {
            const eCriador = demanda.funcionarioId === usuarioLogado.id;
            const eAtribuido = Array.isArray(demanda.atribuidos) && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
            return eCriador || eAtribuido;
        });
    }
    return [];
}

    // Obter demandas dos colaboradores
    // Obter demandas dos colaboradores
function getDemandasDosColaboradores() {
    if (!usuarioLogado || usuarioLogado.role !== 'gestor') return [];
    
    // Para gestores, mostrar todas as demandas que foram criadas por gestores E atribuídas a funcionários
    return todasDemandas.filter(demanda => {
        // Verificar se o criador é um gestor
        const criadorEGestor = usuarios.some(u => u.role === 'gestor' && u.id === demanda.funcionarioId);
        
        // Verificar se foi atribuída a funcionários
        const atribuidaAFuncionarios = Array.isArray(demanda.atribuidos) && 
            demanda.atribuidos.some(a => {
                const usuario = usuarios.find(u => u.id === a.id);
                return usuario && usuario.role === 'funcionario';
            });
        
        // Mostrar se: (foi criada por gestor E atribuída a funcionários) OU (foi criada por funcionário - para manter compatibilidade)
        const criadaPorFuncionario = usuarios.some(u => u.role === 'funcionario' && u.id === demanda.funcionarioId);
        
        return (criadorEGestor && atribuidaAFuncionarios) || criadaPorFuncionario;
    });
}

    // Obter demandas filtradas
    function getDemandasFiltradas() {
        let demandasBase = getDemandasParaUsuarioLogado();

        if (filtroFuncionarioAtual !== 'todos') {
            demandasBase = demandasBase.filter(d => d.funcionarioId == filtroFuncionarioAtual);
        }
        
        const periodo = document.getElementById('filtroPeriodo')?.value;
        if (periodo && periodo !== 'all') {
            const diasAtras = parseInt(periodo);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - diasAtras);
            demandasBase = demandasBase.filter(d => new Date(d.dataCriacao) >= cutoffDate);
        }
        
        const categoria = document.getElementById('filtroCategoria')?.value;
        if (categoria && categoria !== 'todas') {
            demandasBase = demandasBase.filter(d => d.categoria === categoria);
        }
        
        const prioridade = document.getElementById('filtroPrioridade')?.value;
        if (prioridade && prioridade !== 'todas') {
            demandasBase = demandasBase.filter(d => d.prioridade === prioridade);
        }
        
        return demandasBase;
    }

    // Atualizar dashboard
    function atualizarDashboard() {
        const demandasFiltradas = getDemandasFiltradas();
        const totalDemandas = demandasFiltradas.length;
        const pendentes = demandasFiltradas.filter(d => d.status === 'pendente' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'reprovada' || d.status === 'atribuida_pendente_aceitacao').length;
        const atrasadas = demandasFiltradas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        }).length;
        const aprovadas = demandasFiltradas.filter(d => d.status === 'aprovada').length;
        const rotina = demandasFiltradas.filter(d => d.isRotina).length;

        animateValue('totalDemandas', totalDemandas);
        animateValue('pendentesCount', pendentes);
        animateValue('atrasadasCount', atrasadas);
        animateValue('aprovadasCount', aprovadas);
        animateValue('rotinaCount', rotina);
    }

    // Animar valor
    function animateValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const current = parseInt(element.textContent) || 0;
        const increment = value > current ? 1 : -1;
        const duration = 500;
        const steps = Math.abs(value - current);
        
        if (steps === 0) return;
        
        const stepDuration = duration / steps;
        let step = 0;
        
        const timer = setInterval(() => {
            step++;
            element.textContent = current + (increment * step);
            
            if (step >= steps) {
                clearInterval(timer);
                element.textContent = value;
            }
        }, stepDuration);
    }

    // Inicializar gráficos
    function inicializarGraficos() {
        if (typeof Chart === 'undefined') {
            console.log('Chart.js não carregado, pulando inicialização dos gráficos');
            return;
        }
        
        Chart.register(ChartDataLabels);

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            charts.status = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Em Andamento', 'Aprovadas', 'Reprovadas', 'Em Análise'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['rgba(243, 156, 18, 0.8)', 'rgba(39, 174, 96, 0.8)', 'rgba(231, 76, 60, 0.8)', 'rgba(44, 62, 80, 0.8)'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                return percentage;
                            }
                        }
                    }
                }
            });
        }

        atualizarGraficos();
    }

    // Atualizar gráficos
    function atualizarGraficos() {
        if (!charts.status) return;

        const demandasFiltradas = getDemandasFiltradas();

        const statusData = [
            demandasFiltradas.filter(d => d.status === 'pendente' || d.status === 'atribuida_pendente_aceitacao').length,
            demandasFiltradas.filter(d => d.status === 'aprovada').length,
            demandasFiltradas.filter(d => d.status === 'reprovada' || d.status === 'reprovada_pelo_atribuido').length,
            demandasFiltradas.filter(d => d.status === 'finalizado_pendente_aprovacao').length
        ];
        charts.status.data.datasets[0].data = statusData;
        charts.status.update();
    }

    // Formatar data
    function formatDate(date) {
        return new Date(date).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Alternar abas
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => { tab.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(content => { content.classList.remove('active'); });
        
        let targetTab = null;
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                targetTab = tab;
            } else if (tab.textContent.toLowerCase().includes('nova') && tabName === 'nova') {
                targetTab = tab;
            }
        });
        
        if (!targetTab) {
            const tabNames = ['dashboard', 'nova', 'pendentes', 'analise', 'atrasadas', 'aprovadas', 'mindmap', 'notes', 'ranking', 'pendentes-colaboradores', 'cobranca', 'exportar'];
            const index = tabNames.indexOf(tabName);
            if (index !== -1) {
                targetTab = document.querySelectorAll('.tab')[index];
            }
        }
        
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        const contentElement = document.getElementById(tabName);
        if (contentElement) {
            contentElement.classList.add('active');
        }

        if (tabName === 'pendentes') {
            setTimeout(() => { renderizarDemandas(); }, 100);
        } else if (tabName === 'analise') {
            setTimeout(() => { renderizarAnalise(); }, 100);
        } else if (tabName === 'atrasadas') {
            setTimeout(() => { renderizarAtrasadas(); }, 100);
        } else if (tabName === 'aprovadas') {
            setTimeout(() => { renderizarAprovadas(); }, 100);
        } else if (tabName === 'pendentes-colaboradores') {
            setTimeout(() => { renderizarPendentesColaboradores(); }, 100);
        } else if (tabName === 'cobranca') {
            setTimeout(() => { renderizarCobranca(); }, 100);
        } else if (tabName === 'notes') {
            setTimeout(() => { renderizarAnotacoes(); }, 100);
        } else if (tabName === 'mindmap') {
            setTimeout(() => { atualizarMindmap(); }, 100);
        } else if (tabName === 'dashboard') {
            setTimeout(() => { 
                atualizarGraficos(); 
                verificarLembretes();
            }, 100);
        }
    }

    // Mostrar modal
    function showModal(modalId, title, content) {
        const modal = document.getElementById(modalId);
        const modalTitle = document.getElementById('resolucaoModalTitle');
        const modalBody = document.getElementById('modalBody');
        
        if (modalId === 'resolucaoModal') {
            if (modal && modalTitle) {
                modalTitle.textContent = title;
                modal.style.display = 'block';
            }
        } else {
            const modalTitleGeneric = document.getElementById('modalTitle');
            const modalBodyGeneric = document.getElementById('modalBody');
            if (modal && modalTitleGeneric && modalBodyGeneric) {
                modalTitleGeneric.textContent = title;
                modalBodyGeneric.innerHTML = content;
                modal.style.display = 'block';
            }
        }
    }

    // Fechar modal
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            if (modalId === 'resolucaoModal') {
                document.getElementById('resolucaoForm').reset();
                document.getElementById('anexosList').innerHTML = '';
                demandaResolucaoAtual = null;
            }
            if (modalId === 'reprovacaoModal') {
                document.getElementById('reprovacaoForm').reset();
                document.getElementById('deadlineExtension').classList.remove('active');
            }
            if (modalId === 'noteModal') {
                document.getElementById('noteForm').reset();
            }
            if (modalId === 'extendDeadlineModal') {
                document.getElementById('extendDeadlineForm').reset();
            }
        }
    }

    // Ação rápida
    function quickAction() {
        switchTab('nova');
    }

    // Inicializar event listeners
    function inicializarEventListeners() {
        const form = document.getElementById('demandaForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const nomeDemanda = document.getElementById('nomeDemandaInput').value;
                const categoria = document.getElementById('categoriaInput').value;
                const prioridade = document.getElementById('prioridadeSelect').value;
                const complexidade = document.getElementById('complexidadeSelect').value;
                const descricao = document.getElementById('demandaInput').value;
                const local = document.getElementById('localSelect').value;
                const dataLimite = document.getElementById('dataLimiteInput').value;
                const isRotina = document.getElementById('rotinaCheckbox').checked;
                const anexosInput = document.getElementById('anexosCriacaoInput');
                
                if (!nomeDemanda || !categoria || !prioridade || !complexidade || !descricao || !local || !dataLimite) {
                    showNotification('error', 'Erro', 'Por favor, preencha todos os campos obrigatórios');
                    return;
                }
                
                let anexosCriacao = [];
                if (anexosInput.files.length > 0) {
                    for (const file of anexosInput.files) {
                        anexosCriacao.push({ nome: file.name, tamanho: file.size, tipo: file.type });
                    }
                }
                
                let diasSemana = [];
                if (isRotina) {
                    const checkboxes = document.querySelectorAll('input[name="diaSemana"]:checked');
                    diasSemana = Array.from(checkboxes).map(cb => parseInt(cb.value));
                }
                
                const atribuidos = selectedUsers.map(user => ({
                    id: user.id,
                    nome: user.nome,
                    email: user.email
                }));
                
                let statusInicial = 'pendente';
                if (atribuidos.length > 0 && !atribuidos.some(a => a.id === usuarioLogado.id)) {
                    statusInicial = 'pendente';
                }
                
                const novaDemanda = {
                    nomeDemanda,
                    funcionarioId: usuarioLogado.id,
                    nomeFuncionario: usuarioLogado.nome,
                    emailFuncionario: usuarioLogado.email,
                    categoria,
                    prioridade,
                    complexidade,
                    descricao,
                    local,
                    dataLimite,
                    dataCriacao: new Date().toISOString(),
                    status: statusInicial,
                    isRotina,
                    diasSemana,
                    tag: `DEM-${Date.now()}`,
                    comentarios: '',
                    comentarioGestor: '',
                    anexosCriacao,
                    atribuidos: atribuidos
                };
                
                const sucesso = await salvarDemandaNoServidor(novaDemanda);
                
                if (sucesso) {
                    await carregarDadosDoServidor();
                    notificarPartesInteressadasNovaDemanda(novaDemanda);
                    
                    form.reset();
                    document.getElementById('anexosCriacaoList').innerHTML = '';
                    selectedUsers = [];
                    updateSelectedUsers();
                    
                    showNotification('success', 'Demanda Registrada', `Sua demanda "${nomeDemanda}" foi registrada com sucesso!`);
                    
                    setTimeout(() => { switchTab('pendentes'); }, 1000);
                }
            });
        }

        const resolucaoForm = document.getElementById('resolucaoForm');
        if (resolucaoForm) {
            resolucaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarResolucao();
            });
        }

        const reprovacaoForm = document.getElementById('reprovacaoForm');
        if (reprovacaoForm) {
            reprovacaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarReprovacao();
            });
        }

        const extendDeadlineForm = document.getElementById('extendDeadlineForm');
        if (extendDeadlineForm) {
            extendDeadlineForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarExtensaoPrazo();
            });
        }

        const noteForm = document.getElementById('noteForm');
        if (noteForm) {
            noteForm.addEventListener('submit', function(e) {
                e.preventDefault();
                salvarAnotacao();
            });
        }

        const anexosInput = document.getElementById('resolucaoAnexos');
        if (anexosInput) {
            anexosInput.addEventListener('change', atualizarListaAnexos);
        }
        
        const anexosCriacaoInput = document.getElementById('anexosCriacaoInput');
        if (anexosCriacaoInput) {
            anexosCriacaoInput.addEventListener('change', atualizarListaAnexosCriacao);
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-container') && !e.target.closest('.category-search')) {
                document.querySelectorAll('.multi-select-dropdown, .category-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Event listener para o botão de transcrição
        const transcribeBtn = document.getElementById('transcribeBtn');
        if (transcribeBtn) {
            transcribeBtn.addEventListener('click', toggleTranscription);
        }

        // Event listener para o formulário de reatribuição
        const reassignForm = document.getElementById('reassignForm');
        if (reassignForm) {
            reassignForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarReatribuicao();
            });
        }
    }

    // Funções para categoria
    function toggleCategoryDropdown() {
        const dropdown = document.getElementById('categoryDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function filtrarCategorias() {
        const input = document.getElementById('categoriaInput').value.toLowerCase();
        const dropdown = document.getElementById('categoryDropdown');
        const options = dropdown.querySelectorAll('.category-option');
        
        options.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(input)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        if (input) {
            dropdown.style.display = 'block';
        }
    }

    function selectCategory(category) {
        document.getElementById('categoriaInput').value = category;
        document.getElementById('categoryDropdown').style.display = 'none';
        
        if (category === 'Outros') {
            document.getElementById('customCategoryInput').style.display = 'block';
            document.getElementById('customCategory').focus();
        } else {
            document.getElementById('customCategoryInput').style.display = 'none';
        }
    }

    function atualizarListaAnexosCriacao() {
        const anexosInput = document.getElementById('anexosCriacaoInput');
        const anexosList = document.getElementById('anexosCriacaoList');
        anexosList.innerHTML = '';

        if (anexosInput.files.length === 0) {
            anexosList.innerHTML = '<p>Nenhum arquivo selecionado.</p>';
            return;
        }

        for (const file of anexosInput.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>`;
            anexosList.appendChild(fileItem);
        }
    }

    // Notificar partes interessadas sobre nova demanda
    // Notificar partes interessadas sobre nova demanda
// Notificar partes interessadas sobre nova demanda
function notificarPartesInteressadasNovaDemanda(demanda) {
    // Definir gestores por local
    const gestoresPorLocal = {
        'R&D': ['jadson-r@zaminebrasil.com', 'emerson-a@zaminebrasil.com'],
        'Lundin': ['wallysson-s@zaminebrasil.com']
    };
    
    // Obter gestores específicos para o local da demanda
    const gestoresLocal = gestoresPorLocal[demanda.local] || [];
    
    if (usuarioLogado.role === 'gestor') {
        if (demanda.atribuidos && demanda.atribuidos.length > 0) {
            const emailsPara = demanda.atribuidos.map(a => a.email).join(',');
            const assunto = encodeURIComponent(`Nova Tarefa: ${demanda.nomeDemanda}`);
            const corpo = encodeURIComponent(`Prezado(a),\n\nUma nova tarefa foi atribuída a você pelo Gestor:\n\n--- Detalhes da Tarefa ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nLocal: ${demanda.local}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG: ${demanda.tag}\n\nPor favor, acesse o sistema para começar a trabalhar.\n\nAtenciosamente,\nGestor do Sistema`);
            
            let mailtoLink = `mailto:${emailsPara}?subject=${assunto}&body=${corpo}`;
            // Adicionar gestores do local em CC
            if (gestoresLocal.length > 0) {
                mailtoLink += `&cc=${gestoresLocal.join(',')}`;
            }
            window.open(mailtoLink, '_blank');
        }
    } else {
        // Para funcionários, notificar apenas os gestores do local específico
        if (gestoresLocal.length > 0) {
            const emailsCc = demanda.atribuidos && demanda.atribuidos.length > 0 ? demanda.atribuidos.map(a => a.email).join(',') : '';
            const assunto = encodeURIComponent(`Nova Demanda Registrada: ${demanda.nomeDemanda}`);
            let corpo = `Prezado Gestor,\n\nUma nova demanda foi registrada por ${demanda.nomeFuncionario}:\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nLocal: ${demanda.local}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG: ${demanda.tag}\n`;
            
            if (demanda.atribuidos && demanda.atribuidos.length > 0) {
                corpo += `\nEsta demanda foi atribuída a: ${demanda.atribuidos.map(a => a.nome).join(', ')}.\n`;
            }

            corpo += `\nPor favor, acesse o sistema para análise.\n\nAtenciosamente,\nSistema Automático`;

            let mailtoLink = `mailto:${gestoresLocal.join(',')}?subject=${assunto}&body=${encodeURIComponent(corpo)}`;
            if (emailsCc) {
                mailtoLink += `&cc=${emailsCc}`;
            }
            window.open(mailtoLink, '_blank');
        }
    }
}
    // Abrir modal de resolução
    function abrirModalResolucao(demandaId) {
        demandaResolucaoAtual = todasDemandas.find(d => d.id === demandaId);
        if (!demandaResolucaoAtual) return;

        document.getElementById('resolucaoComentarios').value = demandaResolucaoAtual.comentarios || '';
        showModal('resolucaoModal', `Resolver Demanda: ${demandaResolucaoAtual.nomeDemanda}`);
    }

    // Abrir modal de reprovação (sem necessidade de senha)
    function abrirModalReprovar(demandaId) {
        demandaReprovacaoAtual = todasDemandas.find(d => d.id === demandaId);
        if (!demandaReprovacaoAtual) return;

        document.getElementById('motivoReprovacao').value = '';
        document.getElementById('extendDeadline').checked = false;
        document.getElementById('deadlineExtension').classList.remove('active');
        document.getElementById('reprovacaoModal').style.display = 'block';
    }

    // Atualizar lista de anexos
    function atualizarListaAnexos() {
        const anexosInput = document.getElementById('resolucaoAnexos');
        const anexosList = document.getElementById('anexosList');
        anexosList.innerHTML = '';

        if (anexosInput.files.length === 0) {
            anexosList.innerHTML = '<p>Nenhum arquivo selecionado.</p>';
            return;
        }

        for (const file of anexosInput.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>`;
            anexosList.appendChild(fileItem);
        }
    }

    // Salvar resolução
   // Salvar resolução
// Salvar resolução
async function salvarResolucao() {
    if (!demandaResolucaoAtual) {
        showNotification('error', 'Erro', 'Nenhuma demanda selecionada para resolução.');
        return;
    }

    const comentarios = document.getElementById('resolucaoComentarios').value;
    const anexosInput = document.getElementById('resolucaoAnexos');
    const files = anexosInput.files;

    if (!comentarios && files.length === 0) {
        showNotification('warning', 'Ação Incompleta', 'Por favor, adicione comentários ou anexe pelo menos um arquivo.');
        return;
    }

    try {
        // Verificar se há anexos para criar o zip
        if (files.length > 0) {
            const zip = new JSZip();
            const dataConclusao = new Date();
            const zipFileName = `${demandaResolucaoAtual.tag}_${dataConclusao.toISOString().split('T')[0]}.zip`;

            if (comentarios) {
                zip.file("comentarios.txt", comentarios);
            }

            for (const file of files) {
                zip.file(file.name, file);
            }

            const zipBlob = await zip.generateAsync({ type: "blob" });

            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        const dadosAtualizados = {
            comentarios: comentarios,
            status: 'finalizado_pendente_aprovacao',
            dataConclusao: new Date().toISOString()
        };

        const sucesso = await atualizarDemandaNoServidor(demandaResolucaoAtual.id, dadosAtualizados);

        if (sucesso) {
            await carregarDadosDoServidor();
            
            // Redirecionar para a aba de análise para todos os usuários
            switchTab('analise');

            // Definir gestores por local
            const gestoresPorLocal = {
                'R&D': ['jadson-r@zaminebrasil.com', 'emerson-a@zaminebrasil.com'],
                'Lundin': ['wallysson-s@zaminebrasil.com']
            };
            
            // Obter gestores específicos para o local da demanda
            const gestoresLocal = gestoresPorLocal[demandaResolucaoAtual.local] || [];
            
            if(gestoresLocal.length > 0) {
                // Adicionar notificação para os gestores do local
                addUserNotification('info', 'Demanda para Aprovar', `A demanda "${demandaResolucaoAtual.nomeDemanda}" foi resolvida e espera sua aprovação.`, { tag: demandaResolucaoAtual.tag });
                
                // Enviar email para os gestores do local
                const assunto = encodeURIComponent(`Demanda Resolvida para Aprovação: ${demandaResolucaoAtual.nomeDemanda}`);
                const corpo = encodeURIComponent(`Prezado Gestor,\n\nA demanda "${demandaResolucaoAtual.nomeDemanda}" foi resolvida por ${demandaResolucaoAtual.nomeFuncionario} e está aguardando sua aprovação.\n\n--- Detalhes da Demanda ---\nNome: ${demandaResolucaoAtual.nomeDemanda}\nTAG: ${demandaResolucaoAtual.tag}\nLocal: ${demandaResolucaoAtual.local}\n\n--- Comentários do Funcionário ---\n${comentarios}\n\nPor favor, acesse o sistema para aprovar ou reprovar esta demanda.\n\nAtenciosamente,\nSistema de Gestão de Demandas`);
                
                window.open(`mailto:${gestoresLocal.join(',')}?subject=${assunto}&body=${corpo}`, '_blank');
            }
            
            showNotification('success', 'Resolução Salva', `A resolução foi salva e a demanda agora está em análise.`);
            closeModal('resolucaoModal');
        }

    } catch (error) {
        console.error('Erro ao salvar resolução:', error);
        showNotification('error', 'Erro ao Salvar', 'Ocorreu um erro ao processar a resolução.');
    }
}

    // Salvar reprovação (sem necessidade de senha)
   // Salvar reprovação (sem necessidade de senha)
// Salvar reprovação (sem necessidade de senha)
async function salvarReprovacao() {
    if (!demandaReprovacaoAtual) return;

    const motivo = document.getElementById('motivoReprovacao').value;
    const extendDeadline = document.getElementById('extendDeadline').checked;
    const novaDataLimite = document.getElementById('novaDataLimite').value;

    if (!motivo) {
        showNotification('warning', 'Motivo Obrigatório', 'Por favor, informe o motivo da reprovação.');
        return;
    }

    const dadosAtualizados = {
        status: 'reprovada',
        comentarioGestor: motivo,
        dataConclusao: new Date().toISOString()
    };

    if (extendDeadline && novaDataLimite) {
        dadosAtualizados.dataLimite = novaDataLimite;
        dadosAtualizados.status = 'pendente';
    }

    const sucesso = await atualizarDemandaNoServidor(demandaReprovacaoAtual.id, dadosAtualizados);

    if (sucesso) {
        // Definir gestores por local
        const gestoresPorLocal = {
            'R&D': ['jadson-r@zaminebrasil.com', 'emerson-a@zaminebrasil.com'],
            'Lundin': ['wallysson-s@zaminebrasil.com']
        };
        
        // Obter gestores específicos para o local da demanda
        const gestoresLocal = gestoresPorLocal[demandaReprovacaoAtual.local] || [];
        
        const actionText = extendDeadline ? 'reprovada com prazo estendido' : 'reprovada';
        showNotification('warning', `Demanda ${actionText}`, `A demanda foi ${actionText} e o solicitante será notificado.`);
        closeModal('reprovacaoModal');
        await carregarDadosDoServidor();

        const funcionario = usuarios.find(u => u.id === demandaReprovacaoAtual.funcionarioId);
        if (funcionario) {
            const assunto = encodeURIComponent(`Sua Demanda Foi ${actionText}: ${demandaReprovacaoAtual.nomeDemanda}`);
            let corpo = `Prezado(a) ${demandaReprovacaoAtual.nomeFuncionario},\n\nSua demanda foi analisada e ${actionText}.\n\n--- Motivo ---\n${motivo}\n\n`;
            
            if (extendDeadline && novaDataLimite) {
                corpo += `--- Novo Prazo ---\n${new Date(novaDataLimite).toLocaleDateString('pt-BR')}\n\nPor favor, revise e ajuste sua demanda conforme necessário.\n\n`;
            } else {
                corpo += `Por favor, crie uma nova demanda com os ajustes necessários.\n\n`;
            }
            
            corpo += `Atenciosamente,\nGestão`;
            
            // Preparar emails
            let emailsPara = funcionario.email;
            let emailsCc = '';
            
            // Adicionar gestores do local em CC
            if (gestoresLocal.length > 0) {
                emailsCc = gestoresLocal.join(',');
            }
            
            let mailtoLink = `mailto:${emailsPara}?subject=${assunto}&body=${encodeURIComponent(corpo)}`;
            if (emailsCc) {
                mailtoLink += `&cc=${emailsCc}`;
            }
            window.open(mailtoLink, '_blank');

            addUserNotification('warning', `Demanda ${actionText}`, `Sua demanda "${demandaReprovacaoAtual.nomeDemanda}" foi ${actionText}.`, { tag: demandaReprovacaoAtual.tag });
        }
    }

    demandaReprovacaoAtual = null;
}

    // Alternar extensão de prazo
    function toggleDeadlineExtension() {
        const checkbox = document.getElementById('extendDeadline');
        const extension = document.getElementById('deadlineExtension');
        
        if (checkbox.checked) {
            extension.classList.add('active');
        } else {
            extension.classList.remove('active');
        }
    }

    // Renderizar demandas
    // Renderizar demandas
function renderizarDemandas() {
    const demandasDoUsuario = getDemandasParaUsuarioLogado();
    const statusFilter = document.getElementById('pendentesFilter')?.value || 'todos';
    const monthFilter = document.getElementById('pendentesMonthFilter')?.value || '';
    const yearFilter = document.getElementById('pendentesYearFilter')?.value || '';

    const pendentesContainer = document.getElementById('pendentesContainer');
    
    if (pendentesContainer) pendentesContainer.innerHTML = '';

    let pendentes = demandasDoUsuario.filter(d => {
        const matchesStatus = statusFilter === 'todos' || d.status === statusFilter;
        
        const matchesDate = matchesDateFilter(d, monthFilter, yearFilter);
        
        return matchesStatus && matchesDate && (
            d.status === 'pendente' || 
            d.status === 'reprovada' || 
            d.status === 'reprovada_pelo_atribuido' ||
            d.status === 'atribuida_pendente_aceitacao'
        );
    });
    
    if (pendentesContainer) {
        if (pendentes.length === 0) {
            // Mensagem específica para gestores
            if (usuarioLogado && usuarioLogado.role === 'gestor') {
                pendentesContainer.innerHTML = '<p>Você não possui demandas pendentes. Demandas atribuídas a colaboradores aparecem na aba "Pendentes Colaboradores".</p>';
            } else {
                pendentesContainer.innerHTML = '<p>Nenhuma demanda pendente no momento.</p>';
            }
        } else {
            pendentes.forEach(demanda => {
                const elemento = criarElementoDemanda(demanda);
                pendentesContainer.appendChild(elemento);
            });
        }
    }
}
    // Renderizar análise
   // Renderizar análise
function renderizarAnalise() {
    let demandasDoUsuario;
    
    // Para gestores, mostrar todas as demandas em análise dos colaboradores
    if (usuarioLogado && usuarioLogado.role === 'gestor') {
        demandasDoUsuario = todasDemandas.filter(d => d.status === 'finalizado_pendente_aprovacao');
    } else {
        // Para funcionários, mostrar apenas suas próprias demandas em análise
        demandasDoUsuario = getDemandasParaUsuarioLogado().filter(d => d.status === 'finalizado_pendente_aprovacao');
    }
    
    const funcFilter = document.getElementById('analiseFuncFilter')?.value || 'todos';
    const monthFilter = document.getElementById('analiseMonthFilter')?.value || '';
    const yearFilter = document.getElementById('analiseYearFilter')?.value || '';

    const analiseContainer = document.getElementById('analiseContainer');
    
    if (analiseContainer) analiseContainer.innerHTML = '';

    let analise = demandasDoUsuario.filter(d => {
        const matchesFunc = funcFilter === 'todos' || d.funcionarioId == funcFilter;
        const matchesDate = matchesDateFilter(d, monthFilter, yearFilter);
        
        return matchesFunc && matchesDate;
    });
    
    if (analiseContainer) {
        if (analise.length === 0) {
            analiseContainer.innerHTML = '<p>Nenhuma demanda em análise no momento.</p>';
        } else {
            analise.forEach(demanda => {
                const elemento = criarElementoDemanda(demanda);
                analiseContainer.appendChild(elemento);
            });
        }
    }
}

    // Renderizar atrasadas
  // Renderizar atrasadas
function renderizarAtrasadas() {
    // Se for gestor, mostrar todas as demandas atrasadas dos colaboradores
    let demandasParaMostrar;
    if (usuarioLogado && usuarioLogado.role === 'gestor') {
        demandasParaMostrar = todasDemandas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
    } else {
        demandasParaMostrar = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
    }

    // Adicionar filtro por colaborador
    const funcFilter = document.getElementById('atrasadasFuncFilter')?.value || 'todos';
    const monthFilter = document.getElementById('atrasadasMonthFilter')?.value || '';
    const yearFilter = document.getElementById('atrasadasYearFilter')?.value || '';

    const atrasadasContainer = document.getElementById('atrasadasContainer');
    
    if (atrasadasContainer) atrasadasContainer.innerHTML = '';

    let atrasadas = demandasParaMostrar.filter(d => {
        const matchesFunc = funcFilter === 'todos' || d.funcionarioId == funcFilter;
        const matchesDate = matchesDateFilter(d, monthFilter, yearFilter);
        return matchesFunc && matchesDate;
    });
    
    // Mostrar ações em lote se houver demandas atrasadas
    const batchActions = document.getElementById('overdueBatchActions');
    if (batchActions) {
        batchActions.style.display = atrasadas.length > 0 ? 'flex' : 'none';
    }
    
    if (atrasadasContainer) {
        if (atrasadas.length === 0) {
            atrasadasContainer.innerHTML = '<p>Nenhuma demanda atrasada no momento.</p>';
        } else {
            atrasadas.forEach(demanda => {
                atrasadasContainer.appendChild(criarElementoDemandaAtrasada(demanda, true));
            });
        }
    }
}

    // Renderizar aprovadas
   // Renderizar aprovadas
function renderizarAprovadas() {
    let demandasDoUsuario;
    
    // Para gestores, mostrar todas as demandas concluídas dos colaboradores
    if (usuarioLogado && usuarioLogado.role === 'gestor') {
        demandasDoUsuario = todasDemandas.filter(d => d.status === 'aprovada');
    } else {
        demandasDoUsuario = getDemandasParaUsuarioLogado();
    }
    
    // Adicionar filtro por colaborador
    const funcFilter = document.getElementById('aprovadasFuncFilter')?.value || 'todos';
    const monthFilter = document.getElementById('aprovadasMonthFilter')?.value || '';
    const yearFilter = document.getElementById('aprovadasYearFilter')?.value || '';

    const aprovadasContainer = document.getElementById('aprovadasContainer');
    
    if (aprovadasContainer) aprovadasContainer.innerHTML = '';

    let concluidas = demandasDoUsuario.filter(d => {
        const matchesFunc = funcFilter === 'todos' || d.funcionarioId == funcFilter;
        const matchesDate = matchesDateFilter(d, monthFilter, yearFilter);
        
        return matchesFunc && matchesDate && d.status === 'aprovada';
    });
    
    if (aprovadasContainer) {
        if (concluidas.length === 0) {
            aprovadasContainer.innerHTML = '<p>Nenhuma demanda concluída a ser exibida.</p>';
        } else {
            concluidas.forEach(demanda => {
                aprovadasContainer.appendChild(criarElementoDemanda(demanda));
            });
        }
    }
}

    // Renderizar pendentes dos colaboradores
    // Renderizar pendentes dos colaboradores
function renderizarPendentesColaboradores() {
    const demandasColaboradores = getDemandasDosColaboradores();
    const statusFilter = document.getElementById('colabFilter')?.value || 'todos';
    const funcFilter = document.getElementById('colabFuncFilter')?.value || 'todos';
    const localFilter = document.getElementById('colabLocalFilter')?.value || 'todos';
    const monthFilter = document.getElementById('colabMonthFilter')?.value || '';
    const yearFilter = document.getElementById('colabYearFilter')?.value || '';

    const colabContainer = document.getElementById('colabContainer');
    
    if (colabContainer) colabContainer.innerHTML = '';

    let demandas = demandasColaboradores.filter(d => {
        const matchesStatus = statusFilter === 'todos' || d.status === statusFilter;
        const matchesFunc = funcFilter === 'todos' || d.funcionarioId == funcFilter;
        const matchesLocal = localFilter === 'todos' || d.local === localFilter;
        const matchesDate = matchesDateFilter(d, monthFilter, yearFilter);
        
        return matchesStatus && matchesFunc && matchesLocal && matchesDate;
    });
    
    if (colabContainer) {
        if (demandas.length === 0) {
            colabContainer.innerHTML = '<p>Nenhuma demanda dos colaboradores encontrada.</p>';
        } else {
            demandas.forEach(demanda => {
                colabContainer.appendChild(criarElementoDemanda(demanda));
            });
        }
    }
}

    // Função para verificar se a data corresponde aos filtros de mês e ano
    function matchesDateFilter(demanda, monthFilter, yearFilter) {
        if (!monthFilter && !yearFilter) return true;
        
        const data = new Date(demanda.dataCriacao);
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        
        const matchesMonth = !monthFilter || mes === monthFilter;
        const matchesYear = !yearFilter || ano == yearFilter;
        
        return matchesMonth && matchesYear;
    }

    // Filtros
    function filterPendentes() {
        renderizarDemandas();
    }

    function filterAnalise() {
        renderizarAnalise();
    }

    function filterColabDemandas() {
        renderizarPendentesColaboradores();
    }

    function filterAtrasadas() {
        renderizarAtrasadas();
    }

    function filterAprovadas() {
        renderizarAprovadas();
    }

    // Criar elemento de demanda
    function criarElementoDemanda(demanda, isAtrasado = false) {
        // Usa a função de normalizar para garantir que os dados estejam corretos
        demanda = normalizarDadosDemanda(demanda);

        const div = document.createElement('div');
        
        const status = demanda.status || 'pendente';
        const isRotina = demanda.isRotina || false;
        const dataLimite = demanda.dataLimite;
        const statusClass = isAtrasado ? 'atrasado' : status;
        
        div.className = `demanda-item ${statusClass} ${isRotina ? 'rotina' : ''}`;
        
        let statusIcon = '⏳';
        switch (status) {
            case 'aprovada':
                statusIcon = '✅';
                break;
            case 'reprovada':
            case 'reprovada_pelo_atribuido':
                statusIcon = '❌';
                break;
            case 'finalizado_pendente_aprovacao':
                statusIcon = '📋';
                break;
            case 'atribuida_pendente_aceitacao':
                statusIcon = '📋';
                break;
        }
        
        const dataLimiteFormatada = dataLimite ? new Date(dataLimite).toLocaleDateString('pt-BR') : '';
        const rotinaInfo = isRotina ? `<small><i class="fas fa-redo"></i> Tarefa de rotina</small>` : '';
        
        let infoAdicional = '';
        if (status === 'finalizado_pendente_aprovacao') {
            infoAdicional = `<br><small><strong>Comentários do Funcionário:</strong> ${demanda.comentarios || ''}</small>`;
        }
        
        if (status === 'reprovada_pelo_atribuido') {
            infoAdicional = `<br><small><strong>Motivo da Reprovação:</strong> ${demanda.comentarioReprovacaoAtribuicao || ''}</small>`;
        }
        
        if (status === 'reprovada') {
            infoAdicional = `<br><small><strong>Motivo da Reprovação:</strong> ${demanda.comentarioGestor || ''}</small>`;
        }
        
        let diasFormatados = '';
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        if (demanda.isRotina && Array.isArray(demanda.diasSemana) && demanda.diasSemana.length > 0) {
            diasFormatados = demanda.diasSemana.map(dia => ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'][dia]).join(', ');
        }
        
        let tempoElement = '';
        if (status === 'aprovada' && demanda.dataConclusao) {
            const performanceText = calcularDesempenhoTempo(demanda.dataCriacao, demanda.dataConclusao, dataLimite);
            const performanceClass = performanceText.includes('antes') ? 'early' : 'late';
            tempoElement = `<div class="time-performance ${performanceClass}">${performanceText}</div>`;
        } else if (status !== 'finalizado_pendente_aprovacao') {
            // Não mostrar timer para demandas em análise
            const tempoRestante = dataLimite ? calcularTempoRestante(dataLimite) : '';
            tempoElement = `<div class="time-remaining">${isAtrasado ? 'ATRASADA HÁ ' : 'TEMPO RESTANTE: '}${tempoRestante}</div>`;
        }
        
        const prioridade = demanda.prioridade || '';
        const prioridadeBadge = prioridade ? 
            `<span class="demanda-priority priority-${prioridade.toLowerCase()}">${prioridade}</span>` : '';
        
        const podeAprovar = usuarioLogado && usuarioLogado.role === 'gestor';
        const eDono = usuarioLogado && usuarioLogado.id === demanda.funcionarioId;
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        const eAtribuido = usuarioLogado && Array.isArray(demanda.atribuidos) && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
        
        let atribuidosInfo = '';
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        if (Array.isArray(demanda.atribuidos) && demanda.atribuidos.length > 0) {
            atribuidosInfo = `<small><strong>Atribuída a:</strong> ${demanda.atribuidos.map(a => a.nome).join(', ')}</small>`;
        }
        
        div.innerHTML = `
            ${prioridadeBadge}
            <div class="demanda-info">
                <strong>${demanda.nomeFuncionario} - ${demanda.nomeDemanda || demanda.descricao}</strong>
                <small>Categoria: ${demanda.categoria} | ${statusIcon} ${demanda.status.replace(/_/g, ' ')} | Local: ${demanda.local || 'N/A'} | Data Limite: ${dataLimiteFormatada}</small>
                ${atribuidosInfo}
                <small><strong>TAG:</strong> ${demanda.tag || ''}</small>
                ${demanda.comentarioGestor ? `<br><small><strong>Comentário do Gestor:</strong> ${demanda.comentarioGestor || ''}</small>` : ''}
                ${infoAdicional}
                ${rotinaInfo}
                ${diasFormatados ? `<small><strong>Dias da semana:</strong> ${diasFormatados}</small>` : ''}
                ${tempoElement}
            </div>
            <div class="acoes-demandas">
                ${(eDono || eAtribuido) && (demanda.status === 'pendente' || demanda.status === 'reprovada') ? `
                    <button class="success" onclick="abrirModalResolucao(${demanda.id})" title="Resolver Demanda">
                        <i class="fas fa-tools"></i>
                    </button>
                ` : ''}
                ${podeAprovar && (demanda.status === 'finalizado_pendente_aprovacao') ? `
                    <button class="success" onclick="aprovarDemanda(${demanda.id}, '${demanda.nomeFuncionario}')" title="Aprovar">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="danger" onclick="abrirModalReprovar(${demanda.id})" title="Reprovar">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
                <button class="secondary" onclick="verDetalhes(${demanda.id})" title="Ver Detalhes">
                    <i class="fas fa-eye"></i>
                </button>
                ${podeAprovar ? `
                    <button class="danger" onclick="apagarDemanda(${demanda.id})" title="Apagar">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        `;
        
        return div;
    }

    // Criar elemento de demanda atrasada (com checkbox para seleção)
    function criarElementoDemandaAtrasada(demanda, isAtrasado = false) {
        // Usa a função de normalizar para garantir que os dados estejam corretos
        demanda = normalizarDadosDemanda(demanda);

        const div = document.createElement('div');
        
        const status = demanda.status || 'pendente';
        const isRotina = demanda.isRotina || false;
        const dataLimite = demanda.dataLimite;
        const statusClass = isAtrasado ? 'atrasado' : status;
        
        div.className = `demanda-item ${statusClass} ${isRotina ? 'rotina' : ''}`;
        
        let statusIcon = '⏳';
        switch (status) {
            case 'aprovada':
                statusIcon = '✅';
                break;
            case 'reprovada':
            case 'reprovada_pelo_atribuido':
                statusIcon = '❌';
                break;
            case 'finalizado_pendente_aprovacao':
                statusIcon = '📋';
                break;
            case 'atribuida_pendente_aceitacao':
                statusIcon = '📋';
                break;
        }
        
        const dataLimiteFormatada = dataLimite ? new Date(dataLimite).toLocaleDateString('pt-BR') : '';
        const rotinaInfo = isRotina ? `<small><i class="fas fa-redo"></i> Tarefa de rotina</small>` : '';
        
        let infoAdicional = '';
        if (status === 'finalizado_pendente_aprovacao') {
            infoAdicional = `<br><small><strong>Comentários do Funcionário:</strong> ${demanda.comentarios || ''}</small>`;
        }
        
        if (status === 'reprovada_pelo_atribuido') {
            infoAdicional = `<br><small><strong>Motivo da Reprovação:</strong> ${demanda.comentarioReprovacaoAtribuicao || ''}</small>`;
        }
        
        if (status === 'reprovada') {
            infoAdicional = `<br><small><strong>Motivo da Reprovação:</strong> ${demanda.comentarioGestor || ''}</small>`;
        }
        
        let diasFormatados = '';
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        if (demanda.isRotina && Array.isArray(demanda.diasSemana) && demanda.diasSemana.length > 0) {
            diasFormatados = demanda.diasSemana.map(dia => ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'][dia]).join(', ');
        }
        
        const tempoRestante = dataLimite ? calcularTempoRestante(dataLimite) : '';
        
        const prioridade = demanda.prioridade || '';
        const prioridadeBadge = prioridade ? 
            `<span class="demanda-priority priority-${prioridade.toLowerCase()}">${prioridade}</span>` : '';
        
        const podeAprovar = usuarioLogado && usuarioLogado.role === 'gestor';
        const eDono = usuarioLogado && usuarioLogado.id === demanda.funcionarioId;
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        const eAtribuido = usuarioLogado && Array.isArray(demanda.atribuidos) && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
        
        let atribuidosInfo = '';
        // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
        if (Array.isArray(demanda.atribuidos) && demanda.atribuidos.length > 0) {
            atribuidosInfo = `<small><strong>Atribuída a:</strong> ${demanda.atribuidos.map(a => a.nome).join(', ')}</small>`;
        }
        
        // Verificar se esta demanda está selecionada
        const isSelected = selectedOverdueDemands.has(demanda.id);
        
        div.innerHTML = `
            ${prioridadeBadge}
            <input type="checkbox" class="demanda-checkbox" id="checkbox_${demanda.id}" 
                ${isSelected ? 'checked' : ''} 
                onchange="toggleOverdueSelection(${demanda.id})">
            <div class="demanda-info">
                <strong>${demanda.nomeFuncionario} - ${demanda.nomeDemanda || demanda.descricao}</strong>
                <small>Categoria: ${demanda.categoria} | ${statusIcon} ${demanda.status.replace(/_/g, ' ')} | Local: ${demanda.local || 'N/A'} | Data Limite: ${dataLimiteFormatada}</small>
                ${atribuidosInfo}
                <small><strong>TAG:</strong> ${demanda.tag || ''}</small>
                ${demanda.comentarioGestor ? `<br><small><strong>Comentário do Gestor:</strong> ${demanda.comentarioGestor || ''}</small>` : ''}
                ${infoAdicional}
                ${rotinaInfo}
                ${diasFormatados ? `<small><strong>Dias da semana:</strong> ${diasFormatados}</small>` : ''}
                <div class="time-remaining">ATRASADA HÁ ${tempoRestante}</div>
            </div>
            <div class="acoes-demandas">
                ${(eDono || eAtribuido) && (demanda.status === 'pendente' || demanda.status === 'reprovada') ? `
                    <button class="success" onclick="abrirModalResolucao(${demanda.id})" title="Resolver Demanda">
                        <i class="fas fa-tools"></i>
                    </button>
                ` : ''}
                ${podeAprovar && (demanda.status === 'finalizado_pendente_aprovacao') ? `
                    <button class="success" onclick="aprovarDemanda(${demanda.id}, '${demanda.nomeFuncionario}')" title="Aprovar">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="danger" onclick="abrirModalReprovar(${demanda.id})" title="Reprovar">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
                <button class="secondary" onclick="verDetalhes(${demanda.id})" title="Ver Detalhes">
                    <i class="fas fa-eye"></i>
                </button>
                ${podeAprovar ? `
                    <button class="danger" onclick="apagarDemanda(${demanda.id})" title="Apagar">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        `;
        
        return div;
    }

    // Função para alternar seleção de demandas atrasadas
    function toggleOverdueSelection(demandaId) {
        if (selectedOverdueDemands.has(demandaId)) {
            selectedOverdueDemands.delete(demandaId);
        } else {
            selectedOverdueDemands.add(demandaId);
        }
        
        // Atualizar contador
        const countElement = document.getElementById('selectedOverdueCount');
        if (countElement) {
            countElement.textContent = `${selectedOverdueDemands.size} demandas selecionadas`;
        }
    }

    // Selecionar todas as demandas atrasadas
    function selectAllOverdue() {
        const checkboxes = document.querySelectorAll('#atrasadasContainer .demanda-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const demandaId = parseInt(checkbox.id.replace('checkbox_', ''));
            selectedOverdueDemands.add(demandaId);
        });
        
        // Atualizar contador
        const countElement = document.getElementById('selectedOverdueCount');
        if (countElement) {
            countElement.textContent = `${selectedOverdueDemands.size} demandas selecionadas`;
        }
    }

    // Desmarcar todas as demandas atrasadas
    function deselectAllOverdue() {
        const checkboxes = document.querySelectorAll('#atrasadasContainer .demanda-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        selectedOverdueDemands.clear();
        
        // Atualizar contador
        const countElement = document.getElementById('selectedOverdueCount');
        if (countElement) {
            countElement.textContent = '0 demandas selecionadas';
        }
    }

    // Reatribuir demandas atrasadas selecionadas
    function reassignSelectedOverdue() {
        if (selectedOverdueDemands.size === 0) {
            showNotification('warning', 'Nenhuma Demanda Selecionada', 'Por favor, selecione pelo menos uma demanda para reatribuir.');
            return;
        }
        
        // Para simplificar, vamos pegar a primeira demanda selecionada
        const firstDemandaId = Array.from(selectedOverdueDemands)[0];
        const primeiraDemanda = todasDemandas.find(d => d.id === firstDemandaId);
        
        if (primeiraDemanda) {
            abrirModalReatribuicao(firstDemandaId);
        }
    }

    // Estender prazos de demandas atrasadas selecionadas
    function extendSelectedDeadlines() {
        if (selectedOverdueDemands.size === 0) {
            showNotification('warning', 'Nenhuma Demanda Selecionada', 'Por favor, selecione pelo menos uma demanda para estender o prazo.');
            return;
        }
        
        // Para simplificar, vamos pegar a primeira demanda selecionada
        const firstDemandaId = Array.from(selectedOverdueDemands)[0];
        const primeiraDemanda = todasDemandas.find(d => d.id === firstDemandaId);
        
        if (primeiraDemanda) {
            abrirModalExtensaoPrazo(firstDemandaId);
        }
    }

    // Abrir modal de extensão de prazo
    function abrirModalExtensaoPrazo(demandaId) {
        const demanda = todasDemandas.find(d => d.id === demandaId);
        if (!demanda) return;

        document.getElementById('extendDeadlineForm').reset();
        showModal('extendDeadlineModal', 'Estender Prazo da Demanda');
    }

    // Salvar extensão de prazo
    async function salvarExtensaoPrazo() {
        const motivo = document.getElementById('extendReason').value;
        const novaDataLimite = document.getElementById('novaDataLimiteExt').value;

        if (!motivo || !novaDataLimite) {
            showNotification('warning', 'Campos Obrigatórios', 'Por favor, preencha todos os campos.');
            return;
        }

        // Processar cada demanda selecionada
        const promises = Array.from(selectedOverdueDemands).map(async (demandaId) => {
            const demanda = todasDemandas.find(d => d.id === demandaId);
            if (!demanda) return;

            const dadosAtualizados = {
                dataLimite: novaDataLimite,
                comentarioGestor: `Prazo estendido. Motivo: ${motivo}`
            };

            return await atualizarDemandaNoServidor(demandaId, dadosAtualizados);
        });

        try {
            const results = await Promise.all(promises);
            const successCount = results.filter(r => r).length;
            
            if (successCount > 0) {
                showNotification('success', 'Prazos Estendidos', `${successCount} prazos foram estendidos com sucesso.`);
                closeModal('extendDeadlineModal');
                await carregarDadosDoServidor();
                renderizarAtrasadas();
                
                // Notificar os donos das demandas
                Array.from(selectedOverdueDemands).forEach(demandaId => {
                    const demanda = todasDemandas.find(d => d.id === demandaId);
                    if (demanda) {
                        addUserNotification('info', 'Prazo Estendido', 
                            `O prazo da sua demanda "${demanda.nomeDemanda}" foi estendido.`, 
                            { tag: demanda.tag }
                        );

                        // Enviar email para o dono da demanda
                        const dono = usuarios.find(u => u.id === demanda.funcionarioId);
                        if (dono) {
                            const assunto = encodeURIComponent(`Prazo Estendido: ${demanda.nomeDemanda}`);
                            const corpo = encodeURIComponent(`Prezado(a) ${dono.nome},\n\nO prazo da sua demanda foi estendido.\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda}\nTAG: ${demanda.tag}\n\n--- Novo Prazo ---\n${new Date(novaDataLimite).toLocaleDateString('pt-BR')}\n\n--- Motivo da Extensão ---\n${motivo}\n\nPor favor, acesse o sistema para mais detalhes.\n\nAtenciosamente,\nGestão`);
                            
                            window.open(`mailto:${dono.email}?subject=${assunto}&body=${corpo}`, '_blank');
                        }
                    }
                });
            } else {
                showNotification('error', 'Erro ao Estender Prazos', 'Não foi possível estender os prazos das demandas selecionadas.');
            }
        } catch (error) {
            console.error('Erro ao estender prazos:', error);
            showNotification('error', 'Erro ao Estender Prazos', 'Ocorreu um erro ao processar a solicitação.');
        }
    }

    // Calcular desempenho de tempo
    function calcularDesempenhoTempo(dataCriacao, dataConclusao, dataLimite) {
        const conclusao = new Date(dataConclusao);
        const limite = new Date(dataLimite);
        
        const diffMs = conclusao - limite;
        const diffHoras = Math.abs(diffMs) / (1000 * 60 * 60);
        const diffDias = Math.floor(diffHoras / 24);
        const diffHorasRestantes = Math.floor(diffHoras % 24);

        let tempoTexto = '';
        if (diffDias > 0) {
            tempoTexto = `${diffDias} dia(s) e ${diffHorasRestantes} hora(s)`;
        } else {
            tempoTexto = `${diffHorasRestantes} hora(s)`;
        }

        if (diffMs > 0) {
            return `Concluído ${tempoTexto} após o prazo`;
        } else {
            return `Concluído ${tempoTexto} antes do prazo`;
        }
    }

    // Aprovar demanda (sem necessidade de senha)
   // Aprovar demanda (sem necessidade de senha)
// Salvar reprovação (sem necessidade de senha)
async function salvarReprovacao() {
    if (!demandaReprovacaoAtual) return;

    const motivo = document.getElementById('motivoReprovacao').value;
    const extendDeadline = document.getElementById('extendDeadline').checked;
    const novaDataLimite = document.getElementById('novaDataLimite').value;

    if (!motivo) {
        showNotification('warning', 'Motivo Obrigatório', 'Por favor, informe o motivo da reprovação.');
        return;
    }

    const dadosAtualizados = {
        status: 'reprovada',
        comentarioGestor: motivo,
        dataConclusao: new Date().toISOString()
    };

    if (extendDeadline && novaDataLimite) {
        dadosAtualizados.dataLimite = novaDataLimite;
        dadosAtualizados.status = 'pendente';
    }

    const sucesso = await atualizarDemandaNoServidor(demandaReprovacaoAtual.id, dadosAtualizados);

    if (sucesso) {
        // Definir gestores por local
        const gestoresPorLocal = {
            'R&D': ['jadson-r@zaminebrasil.com', 'emerson-a@zaminebrasil.com'],
            'Lundin': ['wallysson-s@zaminebrasil.com']
        };
        
        // Obter gestores específicos para o local da demanda
        const gestoresLocal = gestoresPorLocal[demandaReprovacaoAtual.local] || [];
        
        const actionText = extendDeadline ? 'reprovada com prazo estendido' : 'reprovada';
        showNotification('warning', `Demanda ${actionText}`, `A demanda foi ${actionText} e o solicitante será notificado.`);
        closeModal('reprovacaoModal');
        await carregarDadosDoServidor();

        const funcionario = usuarios.find(u => u.id === demandaReprovacaoAtual.funcionarioId);
        if (funcionario) {
            const assunto = encodeURIComponent(`Sua Demanda Foi ${actionText}: ${demandaReprovacaoAtual.nomeDemanda}`);
            let corpo = `Prezado(a) ${demandaReprovacaoAtual.nomeFuncionario},\n\nSua demanda foi analisada e ${actionText}.\n\n--- Motivo ---\n${motivo}\n\n`;
            
            if (extendDeadline && novaDataLimite) {
                corpo += `--- Novo Prazo ---\n${new Date(novaDataLimite).toLocaleDateString('pt-BR')}\n\nPor favor, revise e ajuste sua demanda conforme necessário.\n\n`;
            } else {
                corpo += `Por favor, crie uma nova demanda com os ajustes necessários.\n\n`;
            }
            
            corpo += `Atenciosamente,\nGestão`;
            
            // Preparar emails
            let emailsPara = funcionario.email;
            let emailsCc = '';
            
            // Adicionar gestores do local em CC
            if (gestoresLocal.length > 0) {
                emailsCc = gestoresLocal.join(',');
            }
            
            let mailtoLink = `mailto:${emailsPara}?subject=${assunto}&body=${encodeURIComponent(corpo)}`;
            if (emailsCc) {
                mailtoLink += `&cc=${emailsCc}`;
            }
            window.open(mailtoLink, '_blank');

            addUserNotification('warning', `Demanda ${actionText}`, `Sua demanda "${demandaReprovacaoAtual.nomeDemanda}" foi ${actionText}.`, { tag: demandaReprovacaoAtual.tag });
        }
    }

    demandaReprovacaoAtual = null;
}
    // Ver detalhes
   // Ver detalhes
// Ver detalhes
function verDetalhes(id) {
    const demanda = todasDemandas.find(d => d.id === id);
    if (!demanda) return;
    
    // Normaliza os dados antes de exibir (criando uma nova constante)
    const demandaNormalizada = normalizarDadosDemanda(demanda);
    
    let tempoInfo = '';
    if (demandaNormalizada.status === 'aprovada' && demandaNormalizada.dataConclusao) {
        tempoInfo = `<p><strong>Desempenho de Tempo:</strong> ${calcularDesempenhoTempo(demandaNormalizada.dataCriacao, demandaNormalizada.dataConclusao, demandaNormalizada.dataLimite)}</p>`;
    }
    
    let atribuidosInfo = '';
    if (Array.isArray(demandaNormalizada.atribuidos) && demandaNormalizada.atribuidos.length > 0) {
        atribuidosInfo = `<p><strong>Atribuída a:</strong> ${demandaNormalizada.atribuidos.map(a => a.nome).join(', ')}</p>`;
    }
    
    // Adicionar informações sobre dias da semana se for rotina
    let diasSemanaInfo = '';
    if (demandaNormalizada.isRotina && Array.isArray(demandaNormalizada.diasSemana) && demandaNormalizada.diasSemana.length > 0) {
        const nomesDias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        const diasFormatados = demandaNormalizada.diasSemana.map(dia => nomesDias[dia]).join(', ');
        diasSemanaInfo = `<p><strong>Dias da Semana:</strong> ${diasFormatados}</p>`;
    }
    
    const content = `
        <div class="demanda-details">
            <h3>${demandaNormalizada.nomeDemanda || 'Sem Título'}</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div>
                    <p><strong>Funcionário:</strong> ${demandaNormalizada.nomeFuncionario}</p>
                    <p><strong>Categoria:</strong> ${demandaNormalizada.categoria}</p>
                    <p><strong>Local:</strong> ${demandaNormalizada.local || 'N/A'}</p>
                    <p><strong>Prioridade:</strong> <span style="color: ${demandaNormalizada.prioridade === 'Importante' ? '#e74c3c' : demandaNormalizada.prioridade === 'Média' ? '#f39c12' : '#27ae60'}">${demandaNormalizada.prioridade}</span></p>
                    <p><strong>Complexidade:</strong> ${demandaNormalizada.complexidade}</p>
                </div>
                <div>
                    <p><strong>Status:</strong> ${demandaNormalizada.status.replace(/_/g, ' ')}</p>
                    <p><strong>Data Criação:</strong> ${new Date(demandaNormalizada.dataCriacao).toLocaleDateString('pt-BR')}</p>
                    <p><strong>Data Limite:</strong> ${new Date(demandaNormalizada.dataLimite).toLocaleDateString('pt-BR')}</p>
                    ${demandaNormalizada.dataConclusao ? `<p><strong>Data Conclusão:</strong> ${new Date(demandaNormalizada.dataConclusao).toLocaleDateString('pt-BR')}</p>` : ''}
                    ${demandaNormalizada.isRotina ? `<p><strong>Tipo:</strong> <span style="color: #9b59b6;">Tarefa de Rotina</span></p>` : ''}
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h4 style="margin-top: 0; color: #2c3e50;">📝 Descrição da Demanda</h4>
                <p style="white-space: pre-wrap; line-height: 1.5;">${demandaNormalizada.descricao || 'Nenhuma descrição informada.'}</p>
            </div>
            
            ${diasSemanaInfo}
            ${tempoInfo}
            ${atribuidosInfo}
            
            ${demandaNormalizada.comentarios ? `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #27ae60;">💬 Comentários do Funcionário</h4>
                    <p style="white-space: pre-wrap; line-height: 1.5;">${demandaNormalizada.comentarios}</p>
                </div>
            ` : ''}
            
            ${demandaNormalizada.comentarioGestor ? `
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #856404;">👔 Comentário do Gestor</h4>
                    <p style="white-space: pre-wrap; line-height: 1.5;">${demandaNormalizada.comentarioGestor}</p>
                </div>
            ` : ''}
            
            ${demandaNormalizada.comentarioReprovacaoAtribuicao ? `
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #721c24;">❌ Motivo da Reprovação</h4>
                    <p style="white-space: pre-wrap; line-height: 1.5;">${demandaNormalizada.comentarioReprovacaoAtribuicao}</p>
                </div>
            ` : ''}
            
            <div style="background: #e9ecef; padding: 10px; border-radius: 5px; text-align: center;">
                <small><strong>TAG:</strong> ${demandaNormalizada.tag}</small>
            </div>
        </div>
    `;
    
    showModal('detailModal', 'Detalhes da Demanda', content);
}

    // Calcular tempo restante
    function calcularTempoRestante(dataLimite) {
        const agora = new Date();
        const limite = new Date(dataLimite);
        const diferenca = limite - agora;
        
        if (diferenca < 0) {
            const diasAtraso = Math.floor(Math.abs(diferenca) / (1000 * 60 * 60 * 24));
            const horasAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutosAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60 * 60)) / (1000 * 60));
            const segundosAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60)) / 1000);
            
            return `${diasAtraso}d ${horasAtraso}h ${minutosAtraso}m ${segundosAtraso}s`;
        } else {
            const diasRestantes = Math.floor(diferenca / (1000 * 60 * 60 * 24));
            const horasRestantes = Math.floor((diferenca % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutosRestantes = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));
            const segundosRestantes = Math.floor((diferenca % (1000 * 60)) / 1000);
            
            return `${diasRestantes}d ${horasRestantes}h ${minutosRestantes}m ${segundosRestantes}s`;
        }
    }

    // Atualizar tempos restantes
    function atualizarTemposRestantes() {
        document.querySelectorAll('.time-remaining').forEach(element => {
            const divPai = element.closest('.demanda-item');
            if (divPai) {
                const botoes = divPai.querySelectorAll('button');
                let demandaId = null;
                
                botoes.forEach(botao => {
                    const onclick = botao.getAttribute('onclick');
                    if (onclick && onclick.includes('abrirModalResolucao')) {
                        const match = onclick.match(/abrirModalResolucao\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('aprovarDemanda')) {
                        const match = onclick.match(/aprovarDemanda\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('abrirModalReprovar')) {
                        const match = onclick.match(/abrirModalReprovar\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('apagarDemanda')) {
                        const match = onclick.match(/apagarDemanda\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    }
                });
                
                if (demandaId) {
                    const demanda = todasDemandas.find(d => d.id === demandaId);
                    
                    if (demanda) {
                        const isAtrasado = divPai.classList.contains('atrasado');
                        const tempoRestante = calcularTempoRestante(demanda.dataLimite);
                        element.textContent = `${isAtrasado ? 'ATRASADA HÁ ' : 'TEMPO RESTANTE: '}${tempoRestante}`;
                    }
                }
            }
        });
    }

    // Apagar demanda
    async function apagarDemanda(id) {
        if (!confirm('Tem certeza que deseja apagar esta demanda? Esta ação não pode ser desfeita.')) return;
        
        const sucesso = await deletarDemandaDoServidor(id);
        
        if (sucesso) {
            await carregarDadosDoServidor();
            showNotification('info', 'Demanda Apagada', 'Demanda removida com sucesso.');
        }
    }

    // Atualizar ranking
    function atualizarRanking() {
        const ranking = {};
        
        // Alteração: No ranking, mostrar apenas os funcionários (não gestores)
        usuarios.filter(u => u.role === 'funcionario').forEach(func => {
            ranking[func.id] = {
                nome: func.nome,
                concluidas: 0,
                andamento: 0,
                atrasadas: 0,
                facil: 0,
                medio: 0,
                dificil: 0,
                tempoMedioEntrega: 0,
                totalDiasEntrega: 0,
                entregasAntesPrazo: 0,
                entregasAposPrazo: 0
            };
        });
        
        todasDemandas.forEach(demanda => {
            if (ranking[demanda.funcionarioId]) {
                if (demanda.status === 'aprovada') {
                    ranking[demanda.funcionarioId].concluidas++;
                    
                    if (demanda.complexidade === 'Fácil') ranking[demanda.funcionarioId].facil++;
                    else if (demanda.complexidade === 'Médio') ranking[demanda.funcionarioId].medio++;
                    else if (demanda.complexidade === 'Difícil') ranking[demanda.funcionarioId].dificil++;
                    
                    if (demanda.dataCriacao && demanda.dataConclusao) {
                        const diasEntrega = Math.ceil((new Date(demanda.dataConclusao) - new Date(demanda.dataCriacao)) / (1000 * 60 * 60 * 24));
                        ranking[demanda.funcionarioId].totalDiasEntrega += diasEntrega;
                        
                        if (demanda.dataLimite) {
                            if (new Date(demanda.dataConclusao) <= new Date(demanda.dataLimite)) {
                                ranking[demanda.funcionarioId].entregasAntesPrazo++;
                            } else {
                                ranking[demanda.funcionarioId].entregasAposPrazo++;
                            }
                        }
                    }
                               } else if (demanda.status === 'pendente' || demanda.status === 'finalizado_pendente_aprovacao' || demanda.status === 'reprovada' || demanda.status === 'reprovada_pelo_atribuido') {
                    ranking[demanda.funcionarioId].andamento++;
                }
                
                const dataLimite = new Date(demanda.dataLimite);
                const hoje = new Date();
                if (dataLimite < hoje && demanda.status !== 'aprovada') {
                    ranking[demanda.funcionarioId].atrasadas++;
                }
            }

            // A verificação agora é segura, pois normalizarDadosDemanda garante que é um array
            if (Array.isArray(demanda.atribuidos)) {
                demanda.atribuidos.forEach(atribuido => {
                    if (ranking[atribuido.id]) {
                        if (demanda.status === 'aprovada') {
                            ranking[atribuido.id].concluidas++;
                            
                            if (demanda.complexidade === 'Fácil') ranking[atribuido.id].facil++;
                            else if (demanda.complexidade === 'Médio') ranking[atribuido.id].medio++;
                            else if (demanda.complexidade === 'Difícil') ranking[atribuido.id].dificil++;
                            
                            if (demanda.dataCriacao && demanda.dataConclusao) {
                                const diasEntrega = Math.ceil((new Date(demanda.dataConclusao) - new Date(demanda.dataCriacao)) / (1000 * 60 * 60 * 24));
                                ranking[atribuido.id].totalDiasEntrega += diasEntrega;
                                
                                if (demanda.dataLimite) {
                                    if (new Date(demanda.dataConclusao) <= new Date(demanda.dataLimite)) {
                                        ranking[atribuido.id].entregasAntesPrazo++;
                                    } else {
                                        ranking[atribuido.id].entregasAposPrazo++;
                                    }
                                }
                            }
                        } else if (demanda.status === 'pendente' || demanda.status === 'finalizado_pendente_aprovacao' || demanda.status === 'reprovada' || demanda.status === 'reprovada_pelo_atribuido') {
                            ranking[atribuido.id].andamento++;
                        }
                        
                        const dataLimite = new Date(demanda.dataLimite);
                        const hoje = new Date();
                        if (dataLimite < hoje && demanda.status !== 'aprovada') {
                            ranking[atribuido.id].atrasadas++;
                        }
                    }
                });
            }
        });
        
        // Calcular tempo médio de entrega
        Object.keys(ranking).forEach(funcId => {
            if (ranking[funcId].concluidas > 0) {
                ranking[funcId].tempoMedioEntrega = Math.round(ranking[funcId].totalDiasEntrega / ranking[funcId].concluidas);
            }
        });
        
        const rankingArray = Object.values(ranking).sort((a, b) => b.concluidas - a.concluidas);
        
        const rankingList = document.getElementById('rankingList');
        if (rankingList) {
            rankingList.innerHTML = '';
            
            rankingArray.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                
                const percentualAntesPrazo = item.concluidas > 0 ? Math.round((item.entregasAntesPrazo / item.concluidas) * 100) : 0;
                
                li.innerHTML = `
                    <div class="ranking-position">${index + 1}</div>
                    <div class="ranking-info">
                        <strong>${item.nome}</strong>
                        <div class="ranking-stats">
                            <div class="ranking-stat">
                                <span class="stat-badge concluidas">${item.concluidas} concluídas</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge andamento">${item.andamento} em andamento</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge atrasadas">${item.atrasadas} atrasadas</span>
                            </div>
                        </div>
                        <div class="ranking-stats">
                            <div class="ranking-stat">
                                <span class="stat-badge">Fácil: ${item.facil}</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge">Médio: ${item.medio}</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge">Difícil: ${item.dificil}</span>
                            </div>
                        </div>
                        <div class="ranking-stats">
                            <div class="ranking-stat">
                                <span class="stat-badge">Tempo médio: ${item.tempoMedioEntrega} dias</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge">Pontualidade: ${percentualAntesPrazo}%</span>
                            </div>
                        </div>
                    </div>
                `;
                
                rankingList.appendChild(li);
            });
        }
    }

    // Validar data limite
    function validateDeadline() {
        const deadlineInput = document.getElementById('dataLimiteInput');
        if (!deadlineInput) return;
        
        const deadline = new Date(deadlineInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (deadline < today) {
            showNotification('warning', 'Data Inválida', 'A data limite não pode ser anterior a hoje');
            deadlineInput.value = '';
        }
    }

    // Alternar campos de rotina
    function toggleRoutineFields() {
        const rotinaCheckbox = document.getElementById('rotinaCheckbox');
        const diasSemanaGroup = document.getElementById('diasSemanaGroup');
        
        if (diasSemanaGroup) {
            diasSemanaGroup.style.display = rotinaCheckbox.checked ? 'block' : 'none';
        }
    }

    // Mostrar notificação
    function showNotification(type, title, message) {
        const notification = document.getElementById('notification');
        const titleElement = document.getElementById('notificationTitle');
        const messageElement = document.getElementById('notificationMessage');
        
        if (!notification || !titleElement || !messageElement) {
            console.error('Elementos de notificação não encontrados!');
            return;
        }
        
        notification.className = `notification ${type} show`;
        titleElement.textContent = title;
        messageElement.textContent = message;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    // Resetar filtros
    function resetFilters() {
        document.getElementById('filtroFuncionario').value = 'todos';
        document.getElementById('filtroPeriodo').value = '7';
        document.getElementById('filtroCategoria').value = 'todas';
        document.getElementById('filtroPrioridade').value = 'todas';
        
        filtrarDashboard();
        showNotification('info', 'Filtros Resetados', 'Todos os filtros foram resetados');
    }

    // Filtrar dashboard
    function filtrarDashboard() {
        filtroFuncionarioAtual = document.getElementById('filtroFuncionario').value;
        atualizarDashboard();
        atualizarGraficos();
    }

    // Drill down
    function drillDown(type) {
        showNotification('info', 'Análise Detalhada', `Analisando detalhes de ${type}...`);
        
        setTimeout(() => {
            switchTab('pendentes');
        }, 1000);
    }

    // Inicializar importação JSON
    function inicializarImportacaoJSON() {
    }

    // Verificar lembretes
    function verificarLembretes() {
        const reminderContainer = document.getElementById('reminderContainer');
        const reminderList = document.getElementById('reminderList');
        
        if (!reminderContainer || !reminderList) return;
        
        const agora = new Date();
        const amanha = new Date(agora);
        amanha.setDate(amanha.getDate() + 1);
        
        // Filtrar demandas que vencem nas próximas 24 horas
        const demandasProximas = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada' || d.status === 'reprovada') return false;
            
            const dataLimite = new Date(d.dataLimite);
            return dataLimite >= agora && dataLimite <= amanha;
        });
        
        if (demandasProximas.length > 0) {
            reminderContainer.style.display = 'block';
            reminderList.innerHTML = '';
            
            demandasProximas.forEach(demanda => {
                const reminderItem = document.createElement('div');
                reminderItem.className = 'reminder-item';
                
                const dataLimite = new Date(demanda.dataLimite);
                const horasRestantes = Math.floor((dataLimite - agora) / (1000 * 60 * 60));
                
                reminderItem.innerHTML = `
                    <strong>${demanda.nomeDemanda}</strong>
                    <p>Vence em ${horasRestantes} horas</p>
                    <small>TAG: ${demanda.tag}</small>
                `;
                
                reminderList.appendChild(reminderItem);
            });
        } else {
            reminderContainer.style.display = 'none';
        }
    }

    // Renderizar cobrança
    function renderizarCobranca() {
        const cobrancaContainer = document.getElementById('cobrancaContainer');
        if (!cobrancaContainer) return;
        
        const funcionarioFilter = document.getElementById('cobrancaFuncionario').value;
        const prioridadeFilter = document.getElementById('cobrancaPrioridade').value;
        
        let atrasadas = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (funcionarioFilter !== 'todos') {
            atrasadas = atrasadas.filter(d => d.funcionarioId == funcionarioFilter);
        }
        
        if (prioridadeFilter !== 'todas') {
            atrasadas = atrasadas.filter(d => d.prioridade === prioridadeFilter);
        }
        
        cobrancaContainer.innerHTML = '';
        
        if (atrasadas.length === 0) {
            cobrancaContainer.innerHTML = '<p>Nenhuma demanda atrasada encontrada com os filtros selecionados.</p>';
            return;
        }
        
        const demandasPorFuncionario = {};
        atrasadas.forEach(demanda => {
            if (!demandasPorFuncionario[demanda.funcionarioId]) {
                demandasPorFuncionario[demanda.funcionarioId] = {
                    nome: demanda.nomeFuncionario,
                    email: demanda.emailFuncionario,
                    demandas: []
                };
            }
            demandasPorFuncionario[demanda.funcionarioId].demandas.push(demanda);
        });
        
        Object.values(demandasPorFuncionario).forEach(funcionario => {
            const card = document.createElement('div');
            card.className = 'card';
            
            const checkboxId = `func_${funcionario.nome.replace(/\s+/g, '_')}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <h3><i class="fas fa-user"></i> ${funcionario.nome}</h3>
                    <div class="card-actions">
                        <input type="checkbox" id="${checkboxId}" class="func-checkbox" onchange="toggleFuncionarioSelection('${funcionario.nome.replace(/'/g, "\\'")}')">
                        <label for="${checkboxId}">Selecionar</label>
                    </div>
                </div>
                <div class="demandas-list">
                    ${funcionario.demandas.map(demanda => {
                        const dataLimite = new Date(demanda.dataLimite);
                        const hoje = new Date();
                        const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
                        const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
                        
                        return `
                            <div class="demanda-item atrasado">
                                <div class="demanda-info">
                                    <strong>${demanda.nomeDemanda || demanda.descricao}</strong>
                                    <small>Categoria: ${demanda.categoria} | Prioridade: ${demanda.prioridade} | Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}</small>
                                    <small><strong>TAG:</strong> ${demanda.tag}</small>
                                    <div class="time-remaining">ATRASADA HÁ ${tempoAtraso}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="card-actions">
                    <button class="success" onclick="enviarEmailCobranca('${funcionario.nome}', '${funcionario.email}')">
                        <i class="fas fa-envelope"></i> Enviar Email de Cobrança
                    </button>
                </div>
            `;
            
            cobrancaContainer.appendChild(card);
        });
        
        atualizarPreviaEmail();
    }

    // Filtrar cobrança
    function filtrarCobranca() {
        renderizarCobranca();
    }

    // Resetar filtros de cobrança
    function resetFiltrosCobranca() {
        document.getElementById('cobrancaFuncionario').value = 'todos';
        document.getElementById('cobrancaPrioridade').value = 'todas';
        renderizarCobranca();
    }

    // Selecionar todas as atrasadas
    function selectAllOverdue() {
        document.querySelectorAll('.func-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    // Desmarcar todas as atrasadas
    function deselectAllOverdue() {
        document.querySelectorAll('.func-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    // Alternar seleção de funcionário
    function toggleFuncionarioSelection(nomeFuncionario) {
        console.log(`Seleção alterada para: ${nomeFuncionario}`);
    }

    // Enviar email de cobrança
    function enviarEmailCobranca(nomeFuncionario, emailFuncionario) {
        const demandasAtrasadas = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada') return false;
            if (d.nomeFuncionario !== nomeFuncionario) return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (demandasAtrasadas.length === 0) {
            showNotification('warning', 'Nenhuma Demanda Atrasada', `${nomeFuncionario} não possui demandas atrasadas.`);
            return;
        }
        
        let corpoEmail = `Prezado(a) ${nomeFuncionario},\n\n`;
        corpoEmail += `Identificamos que você possui ${demandasAtrasadas.length} demanda(s) em atraso. Por favor, verifique e regularize a situação o mais breve possível.\n\n`;
        corpoEmail += `--- Demandas em Atraso ---\n\n`;
        
        demandasAtrasadas.forEach(demanda => {
            const dataLimite = new Date(demanda.dataLimite);
            const hoje = new Date();
            const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
            const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
            
            corpoEmail += `• ${demanda.nomeDemanda || demanda.descricao}\n`;
            corpoEmail += `  Categoria: ${demanda.categoria}\n`;
            corpoEmail += `  Prioridade: ${demanda.prioridade}\n`;
            corpoEmail += `  Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}\n`;
            corpoEmail += `  Dias de Atraso: ${diasAtraso}\n`;
            corpoEmail += `  TAG: ${demanda.tag}\n\n`;
        });
        
        corpoEmail += `Por favor, acesse o sistema para atualizar o status das demandas ou entrar em contato caso necessite de suporte.\n\n`;
        corpoEmail += `Atenciosamente,\nGestão`;
        
        const assunto = encodeURIComponent(`Cobrança de Demandas em Atraso - ${demandasAtrasadas.length} pendente(s)`);
        const corpo = encodeURIComponent(corpoEmail);
        
        window.open(`mailto:${emailFuncionario}?subject=${assunto}&body=${corpo}`, '_blank');
        
        showNotification('success', 'Email de Cobrança', `Email de cobrança para ${nomeFuncionario} foi aberto para envio.`);
    }

    // Enviar emails em lote
    function sendBulkEmail() {
        const checkboxes = document.querySelectorAll('.func-checkbox:checked');
        
        if (checkboxes.length === 0) {
            showNotification('warning', 'Nenhum Funcionário Selecionado', 'Por favor, selecione pelo menos um funcionário para enviar emails em lote.');
            return;
        }
        
        if (!confirm(`Tem certeza que deseja enviar emails de cobrança para ${checkboxes.length} funcionário(s)?`)) {
            return;
        }
        
        const emails = [];
        checkboxes.forEach(checkbox => {
            const card = checkbox.closest('.card');
            const nome = card.querySelector('h3').textContent.trim();
            const funcionario = usuarios.find(u => u.nome === nome);
            if (funcionario) {
                emails.push({
                    nome: funcionario.nome,
                    email: funcionario.email
                });
            }
        });
        
        emails.forEach((item, index) => {
            setTimeout(() => {
                enviarEmailCobranca(item.nome, item.email);
            }, index * 1000);
        });
    }

    // Atualizar prévia do email
    function atualizarPreviaEmail() {
        const emailPreview = document.getElementById('emailPreview');
        if (!emailPreview) return;
        
        const funcionarioFilter = document.getElementById('cobrancaFuncionario').value;
        const prioridadeFilter = document.getElementById('cobrancaPrioridade').value;
        
        let atrasadas = getDemandasParaUsuarioLogado().filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (funcionarioFilter !== 'todos') {
            atrasadas = atrasadas.filter(d => d.funcionarioId == funcionarioFilter);
        }
        
        if (prioridadeFilter !== 'todas') {
            atrasadas = atrasadas.filter(d => d.prioridade === prioridadeFilter);
        }
        
        if (atrasadas.length === 0) {
            emailPreview.textContent = 'Nenhuma demanda em atraso encontrada com os filtros atuais.';
            return;
        }
        
        let corpoEmail = `Prezado(a) [Nome do Funcionário],\n\n`;
        corpoEmail += `Identificamos que você possui ${atrasadas.length} demanda(s) em atraso. Por favor, verifique e regularize a situação o mais breve possível.\n\n`;
        corpoEmail += `--- Demandas em Atraso ---\n\n`;
        
        atrasadas.slice(0, 3).forEach(demanda => {
            const dataLimite = new Date(demanda.dataLimite);
            const hoje = new Date();
            const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
            const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
            
            corpoEmail += `• ${demanda.nomeDemanda || demanda.descricao}\n`;
            corpoEmail += `  Categoria: ${demanda.categoria}\n`;
            corpoEmail += `  Prioridade: ${demanda.prioridade}\n`;
            corpoEmail += `  Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}\n`;
            corpoEmail += `  Dias de Atraso: ${diasAtraso}\n`;
            corpoEmail += `  TAG: ${demanda.tag}\n\n`;
        });
        
        if (atrasadas.length > 3) {
            corpoEmail += `... e mais ${atrasadas.length - 3} demanda(s).\n\n`;
        }
        
        corpoEmail += `Por favor, acesse o sistema para atualizar o status das demandas ou entrar em contato caso necessite de suporte.\n\n`;
        corpoEmail += `Atenciosamente,\nGestão`;
        
        emailPreview.textContent = corpoEmail;
    }

    // Exportar demandas
    function exportarDemandas() {
        const format = document.getElementById('exportFormat').value;
        const dadosParaExportar = todasDemandas;

        if (dadosParaExportar.length === 0) {
            showNotification('warning', 'Sem Dados', 'Não há demandas para exportar.');
            return;
        }

        if (format === 'json') {
            exportarJSON(dadosParaExportar);
        } else if (format === 'csv') {
            exportarCSV(dadosParaExportar);
        } else {
            showNotification('error', 'Formato Inválido', 'Selecione um formato de exportação válido (CSV ou JSON).');
        }
    }

    // Exportar JSON
    function exportarJSON(dados) {
        try {
            const jsonString = JSON.stringify(dados, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demandas_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('success', 'Exportação Concluída', 'Os dados foram exportados em formato JSON.');
        } catch (error) {
            console.error('Erro ao exportar JSON:', error);
            showNotification('error', 'Erro na Exportação', 'Ocorreu um erro ao gerar o arquivo JSON.');
        }
    }

    // Exportar CSV
    function exportarCSV(dados) {
        if (dados.length === 0) {
            showNotification('warning', 'Sem Dados', 'Não há dados para exportar.');
            return;
        }
        
        const headers = Object.keys(dados[0]);
        let csvContent = headers.join(',') + '\n';
        
        dados.forEach(item => {
            const values = headers.map(header => {
                let value = item[header] || '';
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            });
            csvContent += values.join(',') + '\n';
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `demandas_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('success', 'Exportação Concluída', 'Os dados foram exportados em formato CSV.');
    }

    // Renderizar todas as abas
  function renderizarTodasAsAbas() {
    renderizarDemandas();
    renderizarAnalise();
    renderizarAtrasadas();
    renderizarAprovadas();
    renderizarPendentesColaboradores();
    renderizarCobranca();
    atualizarBadges();  // Garanta que esta linha esteja presente
    atualizarDashboard();
    atualizarRanking();
    atualizarGraficos();
}

    // Importar demandas
   // Modifique a função importarDemandas() para ficar assim:
// Importar demandas
async function importarDemandas() {
    const fileInput = document.getElementById('importFile');
    if (!fileInput.files.length) {
        showNotification('warning', 'Nenhum Arquivo Selecionado', 'Por favor, selecione um arquivo JSON para importar.');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async function(event) {
        try {
            let importedData = JSON.parse(event.target.result);

            if (!Array.isArray(importedData)) {
                throw new Error("O arquivo JSON deve conter uma lista de demandas.");
            }

            // Normaliza cada demanda importada ANTES de qualquer processamento
            const normalizedImportedData = importedData.map(demanda => normalizarDadosDemanda(demanda));

            let updatedCount = 0;
            let addedCount = 0;
            let skippedCount = 0;
            let savedToServerCount = 0;

            // Mostrar notificação de início da importação
            showNotification('info', 'Importação Iniciada', `Processando ${normalizedImportedData.length} demanda(s)...`);

            // Primeiro, vamos obter as demandas atuais do servidor para garantir que temos a lista mais recente
            await carregarDadosDoServidor();

            for (const demandaImportada of normalizedImportedData) {
                const demandaExistente = todasDemandas.find(d => d.id === demandaImportada.id);
                
                if (demandaExistente) {
                    // Atualiza a demanda existente em todasDemandas
                    const index = todasDemandas.findIndex(d => d.id === demandaImportada.id);
                    if (index !== -1) {
                        todasDemandas[index] = { ...todasDemandas[index], ...demandaImportada };
                        updatedCount++;
                    }
                } else {
                    // Adiciona nova demanda a todasDemandas
                    if (!demandaImportada.id) {
                        demandaImportada.id = Date.now() + Math.random();
                    }
                    
                    if (!demandaImportada.tag) {
                        demandaImportada.tag = `DEM-IMP-${Date.now()}`;
                    }
                    
                    todasDemandas.push(demandaImportada);
                    addedCount++;
                }

                // SALVAR NO SERVIDOR - Esta é a parte que faltava!
                try {
                    const sucesso = await salvarDemandaNoServidor(demandaImportada);
                    if (sucesso) {
                        savedToServerCount++;
                    }
                } catch (error) {
                    console.error('Erro ao salvar demanda importada no servidor:', error);
                    skippedCount++;
                }
            }

            // Força a atualização completa da interface
            renderizarTodasAsAbas();
            atualizarBadges();
            atualizarDashboard();
            atualizarRanking();
            atualizarGraficos();
            
            let message = `Importação concluída. `;
            if (updatedCount > 0) message += `${updatedCount} demanda(s) atualizada(s). `;
            if (addedCount > 0) message += `${addedCount} nova(s) demanda(s) adicionada(s). `;
            if (savedToServerCount > 0) message += `${savedToServerCount} salva(s) no servidor. `;
            if (skippedCount > 0) message += `${skippedCount} demanda(s) ignorada(s) por erro.`;
            
            if (savedToServerCount > 0) {
                showNotification('success', 'Importação Concluída com Sucesso', message);
            } else {
                showNotification('warning', 'Importação Concluída com Alertas', message);
            }
            
            fileInput.value = '';

        } catch (error) {
            console.error('Erro ao importar o arquivo JSON:', error);
            showNotification('error', 'Erro na Importação', `Falha ao ler o arquivo: ${error.message}. Verifique se o formato está correto.`);
        }
    };

    reader.onerror = function() {
        showNotification('error', 'Erro de Leitura', 'Ocorreu um erro ao ler o arquivo selecionado.');
    };

    reader.readAsText(file);
}
    // Mapa Mental - Funções atualizadas
    function atualizarMindmap() {
        const mindmapArea = document.getElementById('mindmapArea');
        if (!mindmapArea) return;

        mindmapArea.innerHTML = '';

        const filter = document.getElementById('mindmapFilter')?.value || 'todos';
        const funcFilter = document.getElementById('mindmapFuncFilter')?.value || 'todos';
        const localFilter = document.getElementById('mindmapLocalFilter')?.value || 'todos';
        const sort = document.getElementById('mindmapSort')?.value || 'prioridade';

        // Alteração: No mapa mental, mostrar todas as demandas dos funcionários para o gestor
        let demandas;
        if (usuarioLogado && usuarioLogado.role === 'gestor') {
            demandas = todasDemandas.filter(d => {
                // Filtrar por funcionário se necessário
                if (funcFilter !== 'todos' && d.funcionarioId != funcFilter) return false;
                
                // Filtrar por local se necessário
                if (localFilter !== 'todos' && d.local !== localFilter) return false;
                
                // Filtrar por status
                if (filter !== 'todos') {                    if (filter === 'atrasado') {
                        const dataLimite = new Date(d.dataLimite);
                        const hoje = new Date();
                        return dataLimite < hoje && d.status !== 'aprovada';
                    } else {
                        return d.status === filter;
                    }
                }
                
                return true;
            });
        } else {
            demandas = getDemandasParaUsuarioLogado().filter(d => d.status !== 'aprovada' && d.status !== 'reprovada');
        }

        // Aplicar ordenação
        demandas.sort((a, b) => {
            if (sort === 'prioridade') {
                const prioridadeOrder = { 'Importante': 3, 'Média': 2, 'Relevante': 1 };
                return prioridadeOrder[b.prioridade] - prioridadeOrder[a.prioridade];
            } else if (sort === 'dataLimite') {
                return new Date(a.dataLimite) - new Date(b.dataLimite);
            } else if (sort === 'categoria') {
                return a.categoria.localeCompare(b.categoria);
            }
            return 0;
        });

        // Adicionar nós para cada tipo de demanda
        const tiposDemanda = [
            { nome: 'Pendentes', filtro: d => d.status === 'pendente' || d.status === 'atribuida_pendente_aceitacao', cor: 'pending' },
            { nome: 'Em Análise', filtro: d => d.status === 'finalizado_pendente_aprovacao', cor: 'in-analysis', posicaoAfastada: true }, // Adicionada propriedade para posicionar mais longe
            { nome: 'Atrasadas', filtro: d => {
                const dataLimite = new Date(d.dataLimite);
                const hoje = new Date();
                return dataLimite < hoje && d.status !== 'aprovada';
            }, cor: 'overdue' },
            { nome: 'Concluídas', filtro: d => d.status === 'aprovada', cor: 'completed' }
        ];

        // Adicionar nó central
        const centralNode = document.createElement('div');
        centralNode.className = 'mindmap-node';
        centralNode.style.left = '50%';
        centralNode.style.top = '30%'; // Ajustado para cima
        centralNode.style.transform = 'translate(-50%, -50%)';
        centralNode.innerHTML = '<i class="fas fa-user"></i> Minhas Demandas';
        mindmapArea.appendChild(centralNode);

        // Adicionar nós para cada tipo de demanda
        tiposDemanda.forEach((tipo, index) => {
            const demandasTipo = demandas.filter(tipo.filtro);
            
            if (demandasTipo.length === 0) return;
            
            // Adicionar nó do tipo
            const tipoNode = document.createElement('div');
            tipoNode.className = `mindmap-node ${tipo.cor}`;
            
            // Posicionar em círculo ao redor do nó central
            let angleCircle, radius, x, y;
            
            // Posicionamento especial para "Em Análise" - mais afastado e para baixo
            if (tipo.posicaoAfastada) {
                angleCircle = Math.PI / 2; // Diretamente para baixo
                radius = 40; // Mais afastado
                x = 50 + radius * Math.cos(angleCircle);
                y = 70; // Mais para baixo
            } else {
                angleCircle = (index / tiposDemanda.length) * 2 * Math.PI;
                radius = 25;
                x = 50 + radius * Math.cos(angleCircle);
                y = 40 + radius * Math.sin(angleCircle);
            }
            
            tipoNode.style.left = `${x}%`;
            tipoNode.style.top = `${y}%`;
            tipoNode.style.transform = 'translate(-50%, -50%)';
            tipoNode.innerHTML = `<strong>${tipo.nome}</strong><br><small>${demandasTipo.length} demandas</small>`;
            
            // Adicionar evento de clique para filtrar
            tipoNode.addEventListener('click', () => {
                document.getElementById('mindmapFilter').value = 
                    tipo.nome === 'Pendentes' ? 'pendente' :
                    tipo.nome === 'Em Análise' ? 'finalizado_pendente_aprovacao' :
                    tipo.nome === 'Atrasadas' ? 'atrasado' :
                    tipo.nome === 'Concluídas' ? 'aprovada' : 'todos';
                atualizarMindmap();
            });
            
            // Adicionar evento de mouseover para mostrar tooltip
            tipoNode.addEventListener('mouseenter', (e) => {
                const tooltip = document.getElementById('tooltip');
                if (tooltip) {
                    tooltip.innerHTML = `<strong>${tipo.nome}</strong><br>${demandasTipo.length} demandas`;
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                    tooltip.classList.add('show');
                }
            });
            
            tipoNode.addEventListener('mouseleave', () => {
                const tooltip = document.getElementById('tooltip');
                if (tooltip) {
                    tooltip.classList.remove('show');
                }
            });
            
            // Tornar arrastável
            makeDraggable(tipoNode);
            
            mindmapArea.appendChild(tipoNode);
            
            // Adicionar nós para cada demanda do tipo
            demandasTipo.forEach((demanda, idx) => {
                const node = document.createElement('div');
                node.className = `mindmap-node ${tipo.cor}`;
                
                // Posicionar em círculo ao redor do nó do tipo
                const angleDemanda = (idx / demandasTipo.length) * 2 * Math.PI;
                const radiusDemanda = 15; // Reduzido para melhor espaçamento
                
                // Calcular posição em porcentagem
                let xDemanda, yDemanda;
                
                if (tipo.posicaoAfastada) {
                    // Para "Em Análise", posicionar em um arco mais amplo
                    const startAngle = Math.PI * 0.7; // Começa um pouco antes de 90 graus
                    const endAngle = Math.PI * 1.3; // Termina um pouco depois de 90 graus
                    const angleRange = endAngle - startAngle;
                    const currentAngle = startAngle + (angleRange * (idx / demandasTipo.length));
                    
                    xDemanda = x + radiusDemanda * Math.cos(currentAngle);
                    yDemanda = y + radiusDemanda * Math.sin(currentAngle);
                } else {
                    xDemanda = x + radiusDemanda * Math.cos(angleDemanda);
                    yDemanda = y + radiusDemanda * Math.sin(angleDemanda);
                }
                
                node.style.left = `${xDemanda}%`;
                node.style.top = `${yDemanda}%`;
                node.style.transform = 'translate(-50%, -50%)';
                node.innerHTML = `<strong>${demanda.nomeDemanda || demanda.descricao}</strong><br><small>${demanda.prioridade}</small>`;
                
                // Adicionar evento de clique para ver detalhes
                node.addEventListener('click', () => verDetalhes(demanda.id));
                
                // Adicionar evento de mouseover para mostrar tooltip
                node.addEventListener('mouseenter', (e) => showTooltip(e, demanda));
                node.addEventListener('mouseleave', hideTooltip);
                
                // Tornar arrastável
                makeDraggable(node);
                
                // Adicionar ID ao nó para referência
                node.id = `node-${demanda.id}`;
                
                mindmapArea.appendChild(node);
            });
        });
    }

    // Filtrar mapa mental
    function filterMindmap() {
        atualizarMindmap();
    }

    // Ordenar mapa mental
    function sortMindmap() {
        atualizarMindmap();
    }

    // Resetar mapa mental
    function resetMindmap() {
        atualizarMindmap();
        showNotification('info', 'Mapa Mental Resetado', 'O layout do mapa mental foi resetado.');
    }

    // Salvar layout do mapa mental
    function saveMindmapLayout() {
        // Implementar salvamento do layout do mapa mental
        showNotification('info', 'Layout Salvo', 'O layout do mapa mental foi salvo.');
    }

    // Carregar layout do mapa mental
    function carregarMindmapLayout() {
        // Implementar carregamento do layout do mapa mental
    }

    // Tornar elemento arrastável
    function makeDraggable(element) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        element.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // Mostrar tooltip
    function showTooltip(event, demanda) {
        const tooltip = document.getElementById('tooltip');
        if (!tooltip) return;

        const dataLimite = new Date(demanda.dataLimite);
        const tempoRestante = calcularTempoRestante(demanda.dataLimite);
        
        tooltip.innerHTML = `
            <strong>${demanda.nomeDemanda || demanda.descricao}</strong><br>
            <small>Categoria: ${demanda.categoria}</small><br>
            <small>Prioridade: ${demanda.prioridade}</small><br>
            <small>Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}</small><br>
            <small>Tempo Restante: ${tempoRestante}</small><br>
            <small>Status: ${demanda.status.replace(/_/g, ' ')}</small>
        `;
        
        tooltip.style.left = event.pageX + 10 + 'px';
        tooltip.style.top = event.pageY + 10 + 'px';
        tooltip.classList.add('show');
    }

    // Esconder tooltip
    function hideTooltip() {
        const tooltip = document.getElementById('tooltip');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }

    // Reatribuir demanda atrasada
    function reassignOverdue() {
        const selectedDemands = document.querySelectorAll('#atrasadasContainer .demanda-item');
        if (selectedDemands.length === 0) {
            showNotification('warning', 'Nenhuma Demanda Selecionada', 'Por favor, selecione uma demanda atrasada para reatribuir.');
            return;
        }

        // Para simplificar, vamos pegar a primeira demanda selecionada
        const firstDemanda = selectedDemands[0];
        if (firstDemanda) {
            const onclick = firstDemanda.querySelector('button[onclick*="verDetalhes"]')?.getAttribute('onclick');
            if (onclick) {
                const match = onclick.match(/verDetalhes\((\d+)\)/);
                if (match) {
                    abrirModalReatribuicao(parseInt(match[1]));
                }
            }
        }
    }

    // Abrir modal de reatribuição
    function abrirModalReatribuicao(demandaId) {
        const demanda = todasDemandas.find(d => d.id === demandaId);
        if (!demanda) return;

        document.getElementById('reassignForm').reset();
        showModal('reassignModal', 'Reatribuir Demanda');
    }

    // Salvar reatribuição
    async function salvarReatribuicao() {
        const novoAtribuidoId = document.getElementById('reassignTo').value;
        const motivo = document.getElementById('reassignReason').value;

        if (!novoAtribuidoId || !motivo) {
            showNotification('warning', 'Campos Obrigatórios', 'Por favor, selecione um funcionário e informe o motivo.');
            return;
        }

        // Processar cada demanda selecionada
        const promises = Array.from(selectedOverdueDemands).map(async (demandaId) => {
            const demanda = todasDemandas.find(d => d.id === demandaId);
            if (!demanda) return;

            const novoAtribuido = usuarios.find(u => u.id == novoAtribuidoId);
            if (!novoAtribuido) return;

            // Adicionar o novo atribuído à lista
            const novosAtribuidos = [...(demanda.atribuidos || []), {
                id: novoAtribuido.id,
                nome: novoAtribuido.nome,
                email: novoAtribuido.email
            }];

            const dadosAtualizados = {
                atribuidos: novosAtribuidos,
                status: 'atribuida_pendente_aceitacao'
            };

            return await atualizarDemandaNoServidor(demandaId, dadosAtualizados);
        });

        try {
            const results = await Promise.all(promises);
            const successCount = results.filter(r => r).length;
            
            if (successCount > 0) {
                showNotification('success', 'Demandas Reatribuídas', `${successCount} demandas foram reatribuídas com sucesso.`);
                closeModal('reassignModal');
                await carregarDadosDoServidor();
                renderizarAtrasadas();
                
                // Notificar os novos atribuídos
                const novoAtribuido = usuarios.find(u => u.id == novoAtribuidoId);
                if (novoAtribuido) {
                    Array.from(selectedOverdueDemands).forEach(demandaId => {
                        const demanda = todasDemandas.find(d => d.id === demandaId);
                        if (demanda) {
                            addUserNotification('info', 'Nova Tarefa Atribuída', 
                                `A tarefa "${demanda.nomeDemanda}" foi atribuída a você. Motivo: ${motivo}`, 
                                { tag: demanda.tag }
                            );

                            // Enviar email para o novo atribuído
                            const assunto = encodeURIComponent(`Nova Tarefa Atribuída: ${demanda.nomeDemanda}`);
                            const corpo = encodeURIComponent(`Prezado(a) ${novoAtribuido.nome},\n\nUma tarefa foi reatribuída a você:\n\n--- Detalhes da Tarefa ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG: ${demanda.tag}\n\nMotivo da reatribuição: ${motivo}\n\nPor favor, acesse o sistema para aceitar ou recusar esta tarefa.\n\nAtenciosamente,\nGestão`);
                            
                            window.open(`mailto:${novoAtribuido.email}?subject=${assunto}&body=${corpo}`, '_blank');
                        }
                    });
                }
            } else {
                showNotification('error', 'Erro ao Reatribuir', 'Não foi possível reatribuir as demandas selecionadas.');
            }
        } catch (error) {
            console.error('Erro ao reatribuir demandas:', error);
            showNotification('error', 'Erro ao Reatribuir', 'Ocorreu um erro ao processar a solicitação.');
        }
    }

    // Estender prazos
    function extendDeadlines() {
        const selectedDemands = document.querySelectorAll('#atrasadasContainer .demanda-item');
        if (selectedDemands.length === 0) {
            showNotification('warning', 'Nenhuma Demanda Selecionada', 'Por favor, selecione uma demanda atrasada para estender o prazo.');
            return;
        }

        // Para simplificar, vamos pegar a primeira demanda selecionada
        const firstDemanda = selectedDemands[0];
        if (firstDemanda) {
            const onclick = firstDemanda.querySelector('button[onclick*="verDetalhes"]')?.getAttribute('onclick');
            if (onclick) {
                const match = onclick.match(/verDetalhes\((\d+)\)/);
                if (match) {
                    const demandaId = parseInt(match[1]);
                    const demanda = todasDemandas.find(d => d.id === demandaId);
                    if (demanda) {
                        // Verificar se faltam menos de 24 horas
                        const dataLimite = new Date(demanda.dataLimite);
                        const agora = new Date();
                        const horasRestantes = (dataLimite - agora) / (1000 * 60 * 60);
                        
                        if (horasRestantes < 24) {
                            // Abrir modal de reprovação com opção de estender prazo
                            abrirModalReprovar(demandaId);
                        } else {
                            showNotification('info', 'Prazo Ainda Longo', 'Esta demanda ainda tem mais de 24 horas para o prazo.');
                        }
                    }
                }
            }
        }
    }

    // Anotações - Funções atualizadas
    function carregarAnotacoes() {
        const storageKey = `notes_${usuarioLogado?.id || 'guest'}`;
        const saved = localStorage.getItem(storageKey);
        
        if (saved) {
            try {
                notes = JSON.parse(saved);
            } catch (e) {
                console.error('Erro ao carregar anotações:', e);
                notes = [];
            }
        } else {
            notes = [];
        }
        
        renderizarAnotacoes();
    }

    function salvarAnotacoes() {
        if (!usuarioLogado) return;
        
        const storageKey = `notes_${usuarioLogado.id}`;
        localStorage.setItem(storageKey, JSON.stringify(notes));
    }

    function renderizarAnotacoes() {
        const notesContainer = document.getElementById('notesContainer');
        if (!notesContainer) return;

        const monthFilter = document.getElementById('notesMonthFilter')?.value || '';
        const yearFilter = document.getElementById('notesYearFilter')?.value || '';

        let filteredNotes = notes;
        if (monthFilter || yearFilter) {
            filteredNotes = notes.filter(note => {
                const noteDate = new Date(note.date);
                const matchesMonth = !monthFilter || String(noteDate.getMonth() + 1).padStart(2, '0') === monthFilter;
                const matchesYear = !yearFilter || noteDate.getFullYear() == yearFilter;
                return matchesMonth && matchesYear;
            });
        }

        if (filteredNotes.length === 0) {
            notesContainer.innerHTML = '<p class="empty-state">Nenhuma anotação encontrada. Crie sua primeira anotação!</p>';
            return;
        }

        notesContainer.innerHTML = '';
        
        filteredNotes.forEach(note => {
            const noteElement = document.createElement('div');
            noteElement.className = 'note-item';
            noteElement.style.borderLeft = `4px solid ${note.color || '#3498db'}`;
            
            noteElement.innerHTML = `
                <div class="note-header">
                    <h4>${note.title}</h4>
                    <div class="note-date">${formatDate(note.date)}</div>
                    ${note.assignedTo ? `<small><strong>Atribuída a:</strong> ${note.assignedTo}</small>` : ''}
                    <div class="note-actions">
                        <button onclick="editNote(${note.id})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteNote(${note.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>
            `;
            
            notesContainer.appendChild(noteElement);
        });
    }

    function addNewNote() {
        document.getElementById('noteModalTitle').textContent = 'Nova Anotação';
        document.getElementById('noteForm').reset();
        document.getElementById('noteModal').style.display = 'block';
    }

    function salvarAnotacao() {
        const title = document.getElementById('noteTitle').value;
        const content = document.getElementById('noteContent').value;
        const color = document.getElementById('noteColor').value;
        const assignedTo = document.getElementById('noteAssignTo').value;

        if (!title || !content) {
            showNotification('warning', 'Campos Obrigatórios', 'Por favor, preencha o título e o conteúdo da anotação.');
            return;
        }

        const newNote = {
            id: Date.now(),
            title,
            content,
            color,
            date: new Date().toISOString(),
            createdBy: usuarioLogado.id,
            assignedTo: assignedTo ? parseInt(assignedTo) : null
        };
        
        notes.unshift(newNote);
        salvarAnotacoes();
        renderizarAnotacoes();
        closeModal('noteModal');
        
        showNotification('success', 'Anotação Salva', 'Sua anotação foi salva com sucesso.');

        // Se a anotação foi atribuída a alguém, notificar
        if (assignedTo) {
            const assignedUser = usuarios.find(u => u.id == assignedTo);
            if (assignedUser) {
                addUserNotification('info', 'Anotação Atribuída', 
                    `Uma anotação "${title}" foi atribuída a você.`, 
                    { tag: `NOTE-${newNote.id}` }
                );
            }
        }
    }

    function editNote(id) {
        const note = notes.find(n => n.id === id);
        if (!note) return;
        
        document.getElementById('noteModalTitle').textContent = 'Editar Anotação';
        document.getElementById('noteTitle').value = note.title;
        document.getElementById('noteContent').value = note.content;
        document.getElementById('noteColor').value = note.color;
        document.getElementById('noteAssignTo').value = note.assignedTo || '';
        
        // Modificar o formulário para atualizar em vez de criar
        const form = document.getElementById('noteForm');
        form.onsubmit = function(e) {
            e.preventDefault();
            
            note.title = document.getElementById('noteTitle').value;
            note.content = document.getElementById('noteContent').value;
            note.color = document.getElementById('noteColor').value;
            note.assignedTo = document.getElementById('noteAssignTo').value ? parseInt(document.getElementById('noteAssignTo').value) : null;
            
            salvarAnotacoes();
            renderizarAnotacoes();
            closeModal('noteModal');
            
            // Restaurar função original
            form.onsubmit = function(e) {
                e.preventDefault();
                salvarAnotacao();
            };
            
            showNotification('success', 'Anotação Atualizada', 'Sua anotação foi atualizada com sucesso.');
        };
        
        document.getElementById('noteModal').style.display = 'block';
    }

    function deleteNote(id) {
        if (!confirm('Tem certeza que deseja excluir esta anotação?')) return;
        
        notes = notes.filter(n => n.id !== id);
        salvarAnotacoes();
        renderizarAnotacoes();
        
        showNotification('info', 'Anotação Excluída', 'A anotação foi excluída com sucesso.');
    }

    // Adicionar filtros de mês e ano às funções existentes
    function filterNotes() {
        renderizarAnotacoes();
    }

    function updateRanking() {
        atualizarRanking();
    }

    // Função para atualizar a interface automaticamente
    async function atualizarInterface() {
        await carregarDadosDoServidor();
        renderizarTodasAsAbas();
        atualizarBadges();
        atualizarDashboard();
        atualizarRanking();
        atualizarGraficos();
    }

    // Adicionar listeners para os novos filtros de mês e ano
    document.addEventListener('DOMContentLoaded', () => {
        // Adicionar listeners para os filtros de mês que já existem
        ['pendentesMonthFilter', 'analiseMonthFilter', 'atrasadasMonthFilter', 'aprovadasMonthFilter', 'colabMonthFilter', 'rankingMonthFilter', 'notesMonthFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => {
                    // A função correspondente será chamada baseada no ID
                    if (id.includes('pendentes')) {
                        filterPendentes();
                    } else if (id.includes('analise')) {
                        filterAnalise();
                    } else if (id.includes('atrasadas')) {
                        filterAtrasadas();
                    } else if (id.includes('aprovadas')) {
                        filterAprovadas();
                    } else if (id.includes('colab')) {
                        filterColabDemandas();
                    } else if (id.includes('ranking')) {
                        updateRanking();
                    } else if (id.includes('notes')) {
                        filterNotes();
                    }
                });
            }
        });

        // Adicionar listeners para os novos filtros de ano
        ['pendentesYearFilter', 'analiseYearFilter', 'atrasadasYearFilter', 'aprovadasYearFilter', 'colabYearFilter', 'rankingYearFilter', 'notesYearFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => {
                    // A função correspondente será chamada baseada no ID
                    if (id.includes('pendentes')) {
                        filterPendentes();
                    } else if (id.includes('analise')) {
                        filterAnalise();
                    } else if (id.includes('atrasadas')) {
                        filterAtrasadas();
                    } else if (id.includes('aprovadas')) {
                        filterAprovadas();
                    } else if (id.includes('colab')) {
                        filterColabDemandas();
                    } else if (id.includes('ranking')) {
                        updateRanking();
                    } else if (id.includes('notes')) {
                        filterNotes();
                    }
                });
            }
        });
    });

    // Fechar modais ao clicar fora
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // Função para exportar demandas concluídas
    function exportCompleted() {
        const demandasConcluidas = todasDemandas.filter(d => d.status === 'aprovada');
        
        if (demandasConcluidas.length === 0) {
            showNotification('warning', 'Sem Dados', 'Não há demandas concluídas para exportar.');
            return;
        }
        
        exportarJSON(demandasConcluidas);
    }

    // Função para exportar ranking
    function exportRanking() {
        const ranking = {};
        
        usuarios.filter(u => u.role === 'funcionario').forEach(func => {
            ranking[func.id] = {
                nome: func.nome,
                email: func.email,
                nivel: func.nivel,
                pontos: func.pontos,
                conquistas: func.conquistas
            };
        });
        
        todasDemandas.forEach(demanda => {
            if (ranking[demanda.funcionarioId]) {
                if (!ranking[demanda.funcionarioId].demandas) {
                    ranking[demanda.funcionarioId].demandas = [];
                }
                ranking[demanda.funcionarioId].demandas.push({
                    nome: demanda.nomeDemanda,
                    status: demanda.status,
                    dataCriacao: demanda.dataCriacao,
                    dataConclusao: demanda.dataConclusao,
                    dataLimite: demanda.dataLimite,
                    categoria: demanda.categoria,
                    prioridade: demanda.prioridade,
                    complexidade: demanda.complexidade
                });
            }
        });
        
        exportarJSON(Object.values(ranking));
    }

    // Função para mudar período do ranking
    function changeRankingPeriod() {
        const period = prompt('Digite o período em dias (ex: 30 para últimos 30 dias):', '30');
        if (period && !isNaN(period)) {
            // Implementar filtro por período
            showNotification('info', 'Período Alterado', `Período alterado para últimos ${period} dias`);
        }
    }

    // Função para atualizar o contador de demandas selecionadas
    function updateSelectedCount() {
        const countElement = document.getElementById('selectedOverdueCount');
        if (countElement) {
            countElement.textContent = `${selectedOverdueDemands.size} demandas selecionadas`;
        }
    }

    // Função para refresh de gráficos
    function refreshChart(chartType) {
        if (charts[chartType]) {
            charts[chartType].update();
            showNotification('info', 'Gráfico Atualizado', `O gráfico de ${chartType} foi atualizado.`);
        }
    }

    // Função para download de gráficos
    function downloadChart(chartType) {
        if (charts[chartType]) {
            const url = charts[chartType].toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = `chart_${chartType}_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showNotification('success', 'Gráfico Baixado', `O gráfico de ${chartType} foi baixado.`);
        }
    }
</script>

</body>
</html>
